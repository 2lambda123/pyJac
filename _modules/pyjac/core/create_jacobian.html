<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyjac.core.create_jacobian &mdash; pyJac 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
    <link rel="top" title="pyJac 1.0.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyjac.core.create_jacobian</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;Creates source code for calculating analytical Jacobian matrix.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Python 2 compatibility</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="c1"># Standard libraries</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Local imports</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">chem_utilities</span> <span class="k">as</span> <span class="n">chem</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mech_interpret</span> <span class="k">as</span> <span class="n">mech</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rate_subs</span> <span class="k">as</span> <span class="n">rate</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mech_auxiliary</span> <span class="k">as</span> <span class="n">aux</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">CUDAParams</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">CParams</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">cache_optimizer</span> <span class="k">as</span> <span class="n">cache</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">shared_memory</span> <span class="k">as</span> <span class="n">shared</span>


<div class="viewcode-block" id="calculate_shared_memory"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.calculate_shared_memory">[docs]</a><span class="k">def</span> <span class="nf">calculate_shared_memory</span><span class="p">(</span><span class="n">rind</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span> <span class="n">pdep_reacs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># need to figure out shared memory stuff</span>
    <span class="n">variable_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">usages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fwd_usage</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">rev_usage</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">pres_mod_usage</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">)</span>
                      <span class="k">else</span> <span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>
                      <span class="p">)</span>
    <span class="n">reac_usages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">))]</span>
    <span class="n">prod_usages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">))]</span>
    <span class="c1"># add variables</span>
    <span class="n">variable_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
        <span class="n">variable_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span>
                             <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">))</span>
                             <span class="p">)</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">:</span>
        <span class="n">variable_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span>
                             <span class="n">pdep_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">))</span>
                             <span class="p">)</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">]):</span>
        <span class="n">variable_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">):</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">reac_usages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reac_usages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nu</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">:</span>
                <span class="n">pres_mod_usage</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">sp</span> <span class="o">==</span> <span class="n">sp2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">)</span>
                       <span class="k">if</span> <span class="n">spec</span><span class="o">==</span><span class="n">sp2</span><span class="p">),</span> <span class="bp">None</span>
                       <span class="p">)</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">reac_usages</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">nu</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">prod_usages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nu</span> <span class="o">-</span> <span class="mi">1</span>
<span class="c1">#already counted in reac</span>
<span class="c1">#                if rxn.pdep or rxn.thd_body:</span>
<span class="c1">#                    pres_mod_usage += 1</span>
                <span class="k">if</span> <span class="n">sp</span> <span class="o">==</span> <span class="n">sp2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">)</span>
                           <span class="k">if</span> <span class="n">spec</span><span class="o">==</span><span class="n">sp2</span><span class="p">),</span> <span class="bp">None</span>
                           <span class="p">)</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">prod_usages</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">usages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwd_usage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
        <span class="n">usages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rev_usage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">:</span>
        <span class="n">usages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pres_mod_usage</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">]):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">+=</span> <span class="n">reac_usages</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">+=</span> <span class="n">prod_usages</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">usages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">JacRateStrat</span> <span class="o">==</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">JacRatesCacheStrat</span><span class="o">.</span><span class="n">Exclude</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
            <span class="n">usages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">usages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">variable_list</span><span class="p">,</span> <span class="n">usages</span></div>


<div class="viewcode-block" id="write_dr_dy"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dr_dy">[docs]</a><span class="k">def</span> <span class="nf">write_dr_dy</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span> <span class="n">pind</span><span class="p">,</span> <span class="n">nspec</span><span class="p">,</span> <span class="n">get_array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># write the T_Pr and T_Fi terms if needed</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span><span class="p">):</span>
        <span class="n">jline</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;pres_mod_temp = &#39;</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span>
            <span class="c1"># dPr/dYj contribution</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
                <span class="c1"># unimolecular/recombination</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;(1.0 / (1.0 + Pr))&#39;</span>
            <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">high</span><span class="p">:</span>
                <span class="c1"># chem-activated bimolecular</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;(-Pr / (1.0 + Pr))&#39;</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">troe</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; - log(fmax(Fcent, 1.0e-300)) * 2.0 * A * (B * &#39;</span>
                          <span class="s1">&#39;{:.16}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span> <span class="o">+</span>
                          <span class="s1">&#39; + A * &#39;</span>
                          <span class="s1">&#39;{:.16}) / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.14</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span> <span class="o">+</span>
                          <span class="s1">&#39;(B * B * B * (1.0 + A * A / (B * B)) &#39;</span>
                          <span class="s1">&#39;* (1.0 + A * A / (B * B)))&#39;</span>
                          <span class="p">)</span>
            <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">sri</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;- X * X * &#39;</span>
                          <span class="s1">&#39;{:.16} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span> <span class="o">+</span>
                          <span class="s1">&#39;log10(fmax(Pr, 1.0e-300)) * &#39;</span>
                          <span class="s1">&#39;log({:.4} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                          <span class="s1">&#39;exp({:.4} / T) + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                          <span class="s1">&#39;exp(T / {:.4}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                          <span class="p">)</span>

            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;) * &#39;</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> \
                     <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">))</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jline</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;  j_temp = -mw_avg * rho_inv * &#39;</span>
    <span class="c1"># next, contribution from dR/dYj</span>
    <span class="c1"># namely the T_dy independent term</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * (&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span>

    <span class="n">reac_nu</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prod_nu</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
        <span class="n">reac_nu</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
            <span class="n">prod_nu</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># get reac and prod nu sums</span>
    <span class="n">reac_nu</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
        <span class="n">prod_nu</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reac_nu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">reac_nu</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">reac_nu</span><span class="p">))</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prod_nu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prod_nu</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - {} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">prod_nu</span><span class="p">))</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">):</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + pres_mod_temp&#39;</span>
    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jline</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">):</span>
        <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
            <span class="n">k0</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">low</span>
            <span class="n">kinf</span> <span class="o">=</span> <span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k0</span> <span class="o">=</span> <span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">]</span>
            <span class="n">kinf</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">high</span>
        <span class="n">jline</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;pres_mod_temp *= &#39;</span>
        <span class="c1">#k0 / kinf</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">k0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">kinf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">k0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">kinf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">k0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">kinf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="c1">#Fi</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">troe</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * pow(Fcent, 1.0 / (1 + A * A / (B * B)))&#39;</span>
        <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">sri</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;* pow({:.6} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># Need to check for negative parameters, and</span>
            <span class="c1"># skip &quot;-&quot; sign if so.</span>
            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(-{:.6} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp({:.6} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + exp(-T / {:.6}), X) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + exp(T / {:.6}), X) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span>
                    <span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;* {:.8e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                         <span class="s1">&#39;pow(T, {:.6}) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                         <span class="p">)</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; / (1.0 + Pr)&#39;</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jline</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span></div>


<div class="viewcode-block" id="write_rates"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_rates">[docs]</a><span class="k">def</span> <span class="nf">write_rates</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog</span><span class="p">):</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  kf = &#39;</span> <span class="o">+</span> <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">)</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  if (pres &lt;= {:.4e}) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf = &#39;</span> <span class="o">+</span> <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">vals2</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  }} else if ((pres &gt; {:.4e}) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                    <span class="s1">&#39;&amp;&amp; (pres &lt;= {:.4e})) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf = log(&#39;</span> <span class="o">+</span>
                    <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                    <span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf2 = log(&#39;</span> <span class="o">+</span>
                    <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">vals2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vals2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                    <span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

            <span class="n">pres_log_diff</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vals2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf = exp(kf + (kf2 - kf) * (log(pres) - &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;{:.16e}) / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span>
                    <span class="s1">&#39;{:.16e})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pres_log_diff</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }} else if (pres &gt; {:.4e}) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf = &#39;</span> <span class="o">+</span> <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rate</span><span class="o">.</span><span class="n">get_cheb_rate</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  kr = kf / Kc&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  kr = &#39;</span> <span class="o">+</span>
                   <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                       <span class="p">)</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                   <span class="p">)</span></div>


<div class="viewcode-block" id="write_dr_dy_species"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dr_dy_species">[docs]</a><span class="k">def</span> <span class="nf">write_dr_dy_species</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">pind</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">,</span> <span class="n">sp_j</span><span class="p">,</span>
                        <span class="n">rind</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span> <span class="n">get_array</span>
                        <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;j_temp&#39;</span>
    <span class="n">last_spec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">mw_frac</span> <span class="o">=</span> <span class="n">sp_j</span><span class="o">.</span><span class="n">mw</span> <span class="o">/</span> <span class="n">specs</span><span class="p">[</span><span class="n">last_spec</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span>
    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * {:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">mw_frac</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(((</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">))</span> <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span>
        <span class="p">):</span>
        <span class="n">alphaij</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">thd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">thd</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span>
                        <span class="k">if</span> <span class="n">thd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">j_sp</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">alphai_nspec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">thd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">thd</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span>
                        <span class="k">if</span> <span class="n">thd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_spec</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alphai_nspec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alphaij</span> <span class="o">-=</span> <span class="n">alphai_nspec</span> <span class="o">*</span> <span class="n">mw_frac</span>
        <span class="k">if</span> <span class="n">alphaij</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alphaij</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">alphaij</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - pres_mod_temp&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + {:.16e} * pres_mod_temp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alphaij</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + pres_mod_temp&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="o">==</span> <span class="n">j_sp</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="o">==</span> <span class="n">last_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="o">==</span> <span class="n">j_sp</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + pres_mod_temp&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - pres_mod_temp * {:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_j</span><span class="o">.</span><span class="n">mw</span> <span class="o">/</span> <span class="n">specs</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>

    <span class="n">s_term</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">)</span> <span class="ow">and</span> \
       <span class="p">((</span><span class="n">j_sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="ow">or</span> <span class="n">last_spec</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span> <span class="ow">or</span> <span class="n">last_spec</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">))</span>
        <span class="p">):</span>
        <span class="n">s_term</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span>
        <span class="n">s_term</span> <span class="o">+=</span> <span class="s1">&#39; * (&#39;</span>

    <span class="k">def</span> <span class="nf">__get_s_term</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">,</span> <span class="n">reac</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;kf&#39;</span> <span class="k">if</span> <span class="n">reac</span> <span class="k">else</span> <span class="s1">&#39;kr&#39;</span>
        <span class="k">if</span> <span class="n">reac</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j_sp</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j_sp</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
                <span class="c1"># integer, so just use multiplication</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">jline</span><span class="p">:</span> <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jline</span><span class="p">:</span> <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;pow(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span> <span class="o">+</span>
                          <span class="s1">&#39;, {})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                          <span class="p">)</span>

        <span class="n">the_list</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="k">if</span> <span class="n">reac</span> <span class="k">else</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span>
        <span class="c1"># loop through remaining reactants</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">the_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">isp</span> <span class="o">==</span> <span class="n">j_sp</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">reac</span> <span class="k">else</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
                <span class="c1"># integer, so just use multiplication</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nu</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">jline</span><span class="p">:</span> <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jline</span><span class="p">:</span> <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;pow(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                          <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                          <span class="p">)</span>
        <span class="k">return</span> <span class="n">jline</span>

    <span class="n">j_sp_add</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">j_sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="n">j_sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
        <span class="n">j_sp_add</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">add</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">j_sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s_term</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
            <span class="n">add</span> <span class="o">+=</span> <span class="n">__get_s_term</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="n">j_sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s_term</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span>
            <span class="k">elif</span> <span class="n">s_term</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">add</span> <span class="o">+=</span> <span class="n">__get_s_term</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">s_term</span> <span class="o">+=</span> <span class="n">add</span>

    <span class="k">if</span> <span class="n">last_spec</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="n">last_spec</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mw_frac</span><span class="p">)</span>
        <span class="n">add</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">j_sp_add</span><span class="p">:</span>
            <span class="n">s_term</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s_term</span> <span class="ow">and</span> <span class="n">s_term</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">pre</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">pre</span>
        <span class="k">if</span> <span class="n">last_spec</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">:</span>
            <span class="n">add</span> <span class="o">+=</span> <span class="n">__get_s_term</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">last_spec</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="n">last_spec</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">add</span> <span class="o">+=</span> <span class="n">__get_s_term</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">last_spec</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">s_term</span> <span class="o">+=</span> <span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39; * (&#39;</span> <span class="o">+</span> <span class="n">add</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s_term</span><span class="p">:</span>
        <span class="n">s_term</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

    <span class="k">return</span> <span class="n">jline</span> <span class="o">+</span> <span class="n">s_term</span></div>


<div class="viewcode-block" id="write_kc"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_kc">[docs]</a><span class="k">def</span> <span class="nf">write_kc</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sum_nu</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">sum_nu</span> <span class="o">+=</span> <span class="n">nu</span>

        <span class="n">lo_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">nu</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                           <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>
                           <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                           <span class="p">]</span>

        <span class="n">lo_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">lo_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lo_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span>
                    <span class="n">lo_array</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                    <span class="p">]</span>

        <span class="n">hi_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">nu</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                           <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>
                           <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                           <span class="p">]</span>

        <span class="n">hi_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">hi_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">hi_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span>
                    <span class="n">hi_array</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                    <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lo_array</span><span class="p">,</span> <span class="n">hi_array</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lo_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lo_array</span><span class="p">))</span>
                                    <span class="p">],</span> \
                                    <span class="p">[</span><span class="n">hi_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hi_array</span><span class="p">))</span>
                                    <span class="p">]</span>

    <span class="n">isFirst</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">T_mid</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
        <span class="c1"># need temperature conditional for equilibrium constants</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;if (T &lt;= {:})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_mid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; then</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">lo_array</span><span class="p">,</span> <span class="n">hi_array</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">T_mid</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  Kc = &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  Kc += &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  Kc = Kc + &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;({:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;logT + T * (&#39;</span>
                 <span class="s1">&#39;{:.16e} + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} * T))) - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  } else {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  else</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  Kc = &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  Kc += &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  Kc = Kc + &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;({:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;logT + T * (&#39;</span>
                 <span class="s1">&#39;{:.16e} + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} * T))) - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;{:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end if</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">isFirst</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;Kc = &#39;</span>
    <span class="k">if</span> <span class="n">sum_nu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">PA</span> <span class="o">/</span> <span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span> <span class="o">**</span> <span class="n">sum_nu</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(Kc)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_infs"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.get_infs">[docs]</a><span class="k">def</span> <span class="nf">get_infs</span><span class="p">(</span><span class="n">rxn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
        <span class="c1"># unimolecular/recombination fall-off</span>
        <span class="n">beta_0minf</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rxn</span><span class="o">.</span><span class="n">b</span>
        <span class="n">E_0minf</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rxn</span><span class="o">.</span><span class="n">E</span>
        <span class="n">k0kinf</span> <span class="o">=</span> <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">A</span><span class="p">,</span>
                                     <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span>
                                     <span class="p">)</span>
    <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">high</span><span class="p">:</span>
        <span class="c1"># chem-activated bimolecular rxn</span>
        <span class="n">beta_0minf</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">b</span> <span class="o">-</span> <span class="n">rxn</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">E_0minf</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">E</span> <span class="o">-</span> <span class="n">rxn</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">k0kinf</span> <span class="o">=</span> <span class="n">rate</span><span class="o">.</span><span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">A</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span>
                                     <span class="p">)</span>
    <span class="k">return</span> <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span><span class="p">,</span> <span class="n">k0kinf</span></div>


<div class="viewcode-block" id="write_dt_comment"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dt_comment">[docs]</a><span class="k">def</span> <span class="nf">write_dt_comment</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rind</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;partial of rxn &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; wrt T&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_dy_comment"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dy_comment">[docs]</a><span class="k">def</span> <span class="nf">write_dy_comment</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rind</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;partial of rxn &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; wrt species&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_dy_y_finish_comment"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dy_y_finish_comment">[docs]</a><span class="k">def</span> <span class="nf">write_dy_y_finish_comment</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;Finish dYk / Yj</span><span class="se">\&#39;</span><span class="s1">s</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;And dT/dYj</span><span class="se">\&#39;</span><span class="s1">s</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_dt_t_comment"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dt_t_comment">[docs]</a><span class="k">def</span> <span class="nf">write_dt_t_comment</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">sp</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;partial of dT wrt T for spec {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_dt_y_comment"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dt_y_comment">[docs]</a><span class="k">def</span> <span class="nf">write_dt_y_comment</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">sp</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;partial of T wrt Y_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_rxn_params_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.get_rxn_params_dt">[docs]</a><span class="k">def</span> <span class="nf">get_rxn_params_dt</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">rev</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">rev</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0e-90</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0e-90</span><span class="p">):</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;{:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                      <span class="s1">&#39;({:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0e-90</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0e-90</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;({:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-90</span><span class="p">):</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e} + ({:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-90</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-90</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;({:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jline</span></div>


<div class="viewcode-block" id="write_db_dt_def"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_db_dt_def">[docs]</a><span class="k">def</span> <span class="nf">write_db_dt_def</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span>
                    <span class="n">dBdT_flag</span><span class="p">,</span> <span class="n">do_unroll</span>
                    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_reacs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double dBdT[{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                <span class="s1">&#39;double * {} dBdT = d_mem-&gt;dBdT&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">t_mid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i_rxn</span> <span class="ow">in</span> <span class="n">rev_reacs</span><span class="p">:</span>
        <span class="n">rxn</span> <span class="o">=</span> <span class="n">reacs</span><span class="p">[</span><span class="n">i_rxn</span><span class="p">]</span>
        <span class="c1"># only reactions with no reverse Arrhenius parameters</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># all participating species</span>
        <span class="k">for</span> <span class="n">sp_ind</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">:</span>

            <span class="c1"># skip if already printed</span>
            <span class="k">if</span> <span class="n">dBdT_flag</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">dBdT_flag</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">t_mid</span><span class="p">:</span>
                <span class="n">t_mid</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">t_mid</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp_ind</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mid_temp</span> <span class="ow">in</span> <span class="n">t_mid</span><span class="p">:</span>
        <span class="c1"># dB/dT evaluation (with temperature conditional)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;if (T &lt;= {:})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mid_temp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; then</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sp_ind</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">t_mid</span><span class="p">[</span><span class="n">mid_temp</span><span class="p">]):</span>
            <span class="n">dBdT</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dBdT&#39;</span><span class="p">,</span> <span class="n">sp_ind</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dBdT</span> <span class="o">+</span>
                    <span class="s1">&#39; = ({:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; + {:.16e} / T) / T&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                    <span class="s1">&#39; + {:.16e} + T&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; * ({:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; + T * ({:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; + {:.16e} * T))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  } else {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  else</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sp_ind</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">t_mid</span><span class="p">[</span><span class="n">mid_temp</span><span class="p">]):</span>
            <span class="n">dBdT</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dBdT&#39;</span><span class="p">,</span> <span class="n">sp_ind</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>  <span class="n">dBdT</span> <span class="o">+</span>
                    <span class="s1">&#39; = ({:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; + {:.16e} / T) / T&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                    <span class="s1">&#39; + {:.16e} + T&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; * ({:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; + T * ({:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; + {:.16e} * T))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">sp_ind</span><span class="p">]</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end if</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_db_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.get_db_dt">[docs]</a><span class="k">def</span> <span class="nf">get_db_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">do_unroll</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">notfirst</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1"># contribution from dBdT terms from</span>
    <span class="c1"># all participating species</span>
    <span class="k">for</span> <span class="n">sp_ind</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sp_ind</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp_ind</span><span class="p">)]</span> <span class="o">-</span>
                  <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp_ind</span><span class="p">)]</span>
                  <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp_ind</span><span class="p">)]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">dBdT</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dBdT&#39;</span><span class="p">,</span> <span class="n">sp_ind</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">notfirst</span><span class="p">:</span>
            <span class="c1"># first entry</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="n">dBdT</span>
            <span class="k">elif</span> <span class="n">nu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">dBdT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span> <span class="o">+</span> <span class="n">dBdT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not first entry</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
            <span class="k">elif</span> <span class="n">nu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nu</span><span class="p">)))</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="n">dBdT</span>
        <span class="n">notfirst</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">for</span> <span class="n">sp_ind</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">:</span>
        <span class="c1"># skip species also in products, already counted</span>
        <span class="k">if</span> <span class="n">sp_ind</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">nu</span> <span class="o">=</span> <span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp_ind</span><span class="p">)]</span>

        <span class="n">dBdT</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dBdT&#39;</span><span class="p">,</span> <span class="n">sp_ind</span><span class="p">)</span>

        <span class="c1"># not first entry</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
        <span class="k">elif</span> <span class="n">nu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nu</span><span class="p">)))</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="n">dBdT</span>

    <span class="k">return</span> <span class="n">jline</span></div>


<div class="viewcode-block" id="write_pr"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_pr">[docs]</a><span class="k">def</span> <span class="nf">write_pr</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">pdep_reacs</span><span class="p">,</span>
             <span class="n">rxn</span><span class="p">,</span> <span class="n">get_array</span><span class="p">,</span> <span class="n">last_conc_temp</span><span class="o">=</span><span class="bp">None</span>
             <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print lines for necessary pressure-dependent variables</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;conc_temp = &#39;</span>
    <span class="n">conc_temp_log</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;m&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># take care of the conc_temp collapsing</span>
        <span class="n">conc_temp_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(m&#39;</span>

        <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">eff</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eff</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + {} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eff</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">eff</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - {} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">eff</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">eff</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">conc_temp_log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">conc_temp_log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isp</span><span class="p">,</span> <span class="n">eff</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="k">if</span> <span class="n">last_conc_temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># need to update based on the last</span>
            <span class="n">new_conc_temp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">conc_temp_log</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">last_conc_temp</span>
                             <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">species</span><span class="p">),</span> <span class="bp">None</span>
                             <span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">coeff</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coeff</span> <span class="o">=</span> <span class="n">alpha</span>
                <span class="k">if</span> <span class="n">coeff</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">new_conc_temp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">species</span><span class="p">,</span> <span class="n">coeff</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">last_conc_temp</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">conc_temp_log</span>
                             <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">species</span><span class="p">),</span> <span class="bp">None</span>
                             <span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">new_conc_temp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">species</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha</span><span class="p">))</span>

            <span class="n">use_conc</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_conc_temp</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conc_temp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">conc_temp_log</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">conc_temp_log</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_conc</span><span class="p">):</span>
                <span class="c1"># remake the line with the updated numbers</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;conc_temp {}= ({}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">use_conc</span> <span class="o">==</span> <span class="n">new_conc_temp</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;m + &#39;</span> <span class="k">if</span> <span class="n">use_conc</span> <span class="o">!=</span> <span class="n">new_conc_temp</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thd_sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">use_conc</span><span class="p">):</span>
                    <span class="n">isp</span> <span class="o">=</span> <span class="n">thd_sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; {}{} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;- &#39;</span> <span class="k">if</span> <span class="n">thd_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
                                 <span class="k">else</span> <span class="s1">&#39;+ &#39;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thd_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                 <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;{} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thd_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;Pr = conc_temp&#39;</span>
        <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span><span class="p">,</span> <span class="n">k0kinf</span> <span class="o">=</span> <span class="n">get_infs</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
        <span class="c1"># finish writing P_ri</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; * (&#39;</span> <span class="o">+</span> <span class="n">k0kinf</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">conc_temp_log</span></div>


<div class="viewcode-block" id="write_troe"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_troe">[docs]</a><span class="k">def</span> <span class="nf">write_troe</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  Fcent = &#39;</span>
            <span class="s1">&#39;{:.16e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
            <span class="s1">&#39;exp(T / {:.16e})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
            <span class="s1">&#39; + {:.16e} * exp(T / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
            <span class="s1">&#39;{:.16e})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + exp({:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  A = log10(fmax(Pr, 1.0e-300)) - 0.67 * &#39;</span>
            <span class="s1">&#39;log10(fmax(Fcent, 1.0e-300)) - 0.4&#39;</span> <span class="o">+</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  B = 0.806 - 1.1762 * log10(fmax(Fcent, 1.0e-300)) - &#39;</span>
            <span class="s1">&#39;0.14 * log10(fmax(Pr, 1.0e-300))&#39;</span> <span class="o">+</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  lnF_AB = 2.0 * log(fmax(Fcent, 1.0e-300)) * &#39;</span>
            <span class="s1">&#39;A / (B * B * B * (1.0 + A * A / (B * B)) * &#39;</span>
            <span class="s1">&#39;(1.0 + A * A / (B * B)))&#39;</span> <span class="o">+</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_sri"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_sri">[docs]</a><span class="k">def</span> <span class="nf">write_sri</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  X = 1.0 / (1.0 + log10(fmax(Pr, 1.0e-300)) * &#39;</span>
            <span class="s1">&#39;log10(fmax(Pr, 1.0e-300)))&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_pdep_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.get_pdep_dt">[docs]</a><span class="k">def</span> <span class="nf">get_pdep_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span> <span class="n">pind</span><span class="p">,</span> <span class="n">get_array</span><span class="p">):</span>
    <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span><span class="p">,</span> <span class="n">k0kinf</span> <span class="o">=</span> <span class="n">get_infs</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
    <span class="n">jline</span> <span class="o">=</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;j_temp = (&#39;</span> <span class="o">+</span>
             <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span>
             <span class="p">)</span>
    <span class="c1"># high -&gt; chem-activated bimolecular rxn</span>
    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * ((&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;-Pr * &#39;</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">high</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># dPr/dT</span>
    <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;({:.4e} + (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta_0minf</span><span class="p">)</span> <span class="o">+</span>
              <span class="s1">&#39;{:.16e} / T) - 1.0) / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E_0minf</span><span class="p">)</span> <span class="o">+</span>
              <span class="s1">&#39;(T * (1.0 + Pr)))&#39;</span>
              <span class="p">)</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">sri</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="n">write_sri_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span><span class="p">,</span> <span class="n">k0kinf</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">troe</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="n">write_troe_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span><span class="p">,</span> <span class="n">k0kinf</span><span class="p">)</span>

    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;) * &#39;</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
        <span class="c1"># forward and reverse reaction rates</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> \
                 <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">))</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># forward reaction rate only</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>

    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + (&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jline</span></div>


<div class="viewcode-block" id="write_sri_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_sri_dt">[docs]</a><span class="k">def</span> <span class="nf">write_sri_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span><span class="p">,</span> <span class="n">k0kinf</span><span class="p">):</span>
    <span class="n">jline</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39; + X * (((&#39;</span>
             <span class="s1">&#39;{:.16} / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;(T * T)) * exp(&#39;</span>
             <span class="s1">&#39;{:.16} / T) - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;{:.16e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;exp(T / {:.16})) / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;({:.16} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;exp({:.16} / T) + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;exp(T / {:.16})) - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;X * {:.16} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span> <span class="o">+</span>
             <span class="s1">&#39;log10(fmax(Pr, 1.0e-300)) * (&#39;</span>
             <span class="s1">&#39;{:.16e} + (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta_0minf</span><span class="p">)</span> <span class="o">+</span>
             <span class="s1">&#39;{:.16e} / T) - 1.0) * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E_0minf</span><span class="p">)</span> <span class="o">+</span>
             <span class="s1">&#39;log({:.16} * exp(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;{:.16} / T) + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;exp(T / &#39;</span>
             <span class="s1">&#39;{:.16})) / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
             <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + ({:.16} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">jline</span></div>


<div class="viewcode-block" id="write_troe_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_troe_dt">[docs]</a><span class="k">def</span> <span class="nf">write_troe_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">beta_0minf</span><span class="p">,</span> <span class="n">E_0minf</span><span class="p">,</span> <span class="n">k0kinf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes section of line for temperature partial derivative of Troe falloff.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lang : str</span>
<span class="sd">        Programming language, {&#39;c&#39;, &#39;cuda&#39;}</span>
<span class="sd">    rxn : `ReacInfo`</span>
<span class="sd">        Reaction of interest; pressure dependence expressed with Troe falloff</span>
<span class="sd">    beta_0minf : float</span>
<span class="sd">    E_0minf : float</span>
<span class="sd">    k0kinf : float</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jline : str</span>
<span class="sd">        Line fragment with Troe temperature derivative</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jline</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39; + (((1.0 / &#39;</span>
             <span class="s1">&#39;(Fcent * (1.0 + A * A / (B * B)))) - &#39;</span>
             <span class="s1">&#39;lnF_AB * (&#39;</span>
             <span class="s1">&#39;-{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.67</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span> <span class="o">+</span>
             <span class="s1">&#39; * B + &#39;</span>
             <span class="s1">&#39;{:.16e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.1762</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span> <span class="o">+</span>
             <span class="s1">&#39;A) / Fcent)&#39;</span>
             <span class="s1">&#39; * ({:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span>
                                 <span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39; * exp(T / &#39;</span>
             <span class="s1">&#39;{:.16e}) - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;{:.16e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span>
                                <span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
             <span class="s1">&#39;exp(T / &#39;</span>
             <span class="s1">&#39;{:.16e})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
             <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; + ({:.16e} / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                  <span class="s1">&#39;(T * T)) * exp(&#39;</span>
                  <span class="s1">&#39;{:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                  <span class="p">)</span>
    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;))&#39;</span>

    <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; - lnF_AB * (&#39;</span>
              <span class="s1">&#39;{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span> <span class="o">+</span>
              <span class="s1">&#39; * B + &#39;</span>
              <span class="s1">&#39;{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.14</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span> <span class="o">+</span>
              <span class="s1">&#39; * A) * &#39;</span>
              <span class="s1">&#39;({:.16e} + (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta_0minf</span><span class="p">)</span> <span class="o">+</span>
              <span class="s1">&#39;{:.16e} / T) - 1.0) / T&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E_0minf</span><span class="p">)</span>
              <span class="p">)</span>

    <span class="k">return</span> <span class="n">jline</span></div>


<div class="viewcode-block" id="write_dcp_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dcp_dt">[docs]</a><span class="k">def</span> <span class="nf">write_dcp_dt</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">T_mid_buckets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># put all of the same T_mids together</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">T_mid_buckets</span><span class="p">:</span>
            <span class="n">T_mid_buckets</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">T_mid_buckets</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isp</span><span class="p">)</span>

    <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">T_mid</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">T_mid_buckets</span><span class="p">):</span>
        <span class="c1"># write the if statement</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;if (T &lt;= {:})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_mid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; then</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="c1"># and the update line</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  working_temp&#39;</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {}= &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;working_temp + &#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">T_mid_buckets</span><span class="p">[</span><span class="n">T_mid</span><span class="p">])):</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    + &#39;</span>

            <span class="n">y_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;y_N&#39;</span>
                     <span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">y_str</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; * {:.16e} * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39;{:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                     <span class="s1">&#39;T * ({:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                     <span class="s1">&#39;T * ({:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                     <span class="s1">&#39;{:.16e} * T)))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                     <span class="s1">&#39;)&#39;</span>
                     <span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># now do the high temperature side</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  } else {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  else</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># and the update line</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  working_temp&#39;</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {}= &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;working_temp + &#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">T_mid_buckets</span><span class="p">[</span><span class="n">T_mid</span><span class="p">])):</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    + &#39;</span>

            <span class="n">y_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;y_N&#39;</span>
                     <span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">y_str</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; * {:.16e} * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39;{:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                     <span class="s1">&#39;T * ({:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                     <span class="s1">&#39;T * ({:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                     <span class="s1">&#39;{:.16e} * T)))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                     <span class="s1">&#39;)&#39;</span>
                     <span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="c1"># and finish the if</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end if</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="get_elementary_rxn_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.get_elementary_rxn_dt">[docs]</a><span class="k">def</span> <span class="nf">get_elementary_rxn_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">,</span>
                          <span class="n">get_array</span><span class="p">,</span> <span class="n">do_unroll</span>
                          <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write contribution from temperature derivative of reaction rate for</span>
<span class="sd">    elementary reaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">:</span>
        <span class="n">dk_dt</span> <span class="o">=</span> <span class="n">get_rxn_params_dt</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">rev</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dk_dt</span> <span class="ow">or</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="c1">#we actually need to do the dk/dt for both</span>
            <span class="n">jline</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * (&#39;</span>
            <span class="k">if</span> <span class="n">dk_dt</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="n">dk_dt</span>

            <span class="c1"># loop over reactants</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dk_dt</span> <span class="ow">and</span> <span class="n">jline</span><span class="p">:</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="n">dk_dt</span> <span class="o">=</span> <span class="n">get_rxn_params_dt</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">rev</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dk_dt</span> <span class="ow">or</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> \
            <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">)</span> <span class="o">+</span> \
            <span class="s1">&#39; * (&#39;</span>

            <span class="k">if</span> <span class="n">dk_dt</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="n">dk_dt</span>

            <span class="c1"># product nu sum</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dk_dt</span> <span class="ow">and</span> <span class="n">jline</span><span class="p">:</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
        <span class="c1">#we don&#39;t need the dk/dt for both,</span>
        <span class="c1">#so write different to not calculate twice, and instead</span>
        <span class="c1">#rely on loading fwd/rev rates again, as they should</span>
        <span class="c1">#be cached</span>

        <span class="n">dk_dt</span> <span class="o">=</span> <span class="n">get_rxn_params_dt</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">rev</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dk_dt</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> \
                <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">)</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * (&#39;</span>

            <span class="n">jline</span> <span class="o">+=</span> <span class="n">dk_dt</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="c1"># loop over reactants</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jline</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>

        <span class="n">dbdt</span> <span class="o">=</span> <span class="n">get_db_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">do_unroll</span><span class="p">)</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dbdt</span> <span class="ow">or</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jline</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">)</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * (&#39;</span>
            <span class="c1"># product nu sum</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">dbdt</span><span class="p">:</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;-T * (&#39;</span>

                <span class="c1"># product nu sum</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="n">dbdt</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;))&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#forward only, combine dk/dt and nu sum</span>
        <span class="n">dk_dt</span> <span class="o">=</span> <span class="n">get_rxn_params_dt</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">rev</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dk_dt</span> <span class="ow">or</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * (&#39;</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="n">dk_dt</span>

            <span class="c1"># loop over reactants</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jline</span><span class="p">:</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>

            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>


    <span class="c1"># print line for reaction</span>
    <span class="k">if</span> <span class="n">jline</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)) * rho_inv&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jline</span></div>


<div class="viewcode-block" id="write_cheb_ut"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_cheb_ut">[docs]</a><span class="k">def</span> <span class="nf">write_cheb_ut</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cheb_temp_0 = 1&#39;</span><span class="p">)</span>
    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cheb_temp_1 = Pred&#39;</span><span class="p">)</span>
    <span class="c1">#start pressure dot product</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span><span class="p">):</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span>
          <span class="s1">&#39;= {:.16e} + Pred * {:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_par</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">i</span> <span class="o">*</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_par</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

    <span class="c1">#finish pressure dot product</span>
    <span class="n">update_one</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_pres</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">update_one</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;cheb_temp_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = 2 * Pred * cheb_temp_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - cheb_temp_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span><span class="p">):</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="o">+</span>
              <span class="s1">&#39; += {:.16e} * cheb_temp_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">i</span> <span class="o">*</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_par</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">old</span><span class="p">))</span>

        <span class="n">update_one</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">update_one</span>

    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cheb_temp_0 = 1.0&#39;</span><span class="p">)</span>
    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cheb_temp_1 = 2.0 * Tred&#39;</span><span class="p">)</span>
    <span class="c1">#finally, do the temperature portion</span>
    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;kf = &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39; + 2.0 * Tred * &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                     <span class="p">)</span>

    <span class="n">update_one</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">update_one</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;cheb_temp_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = 2.0 * Tred * cheb_temp_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - cheb_temp_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;kf += &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="s1">&#39;cheb_temp_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">))</span>

        <span class="n">update_one</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">update_one</span>

    <span class="n">line_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="k">for</span>
                  <span class="n">line</span> <span class="ow">in</span> <span class="n">line_list</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_list</span><span class="p">))</span></div>


<div class="viewcode-block" id="write_cheb_rxn_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_cheb_rxn_dt">[docs]</a><span class="k">def</span> <span class="nf">write_cheb_rxn_dt</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">jline</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">,</span>
                      <span class="n">specs</span><span class="p">,</span> <span class="n">get_array</span><span class="p">,</span> <span class="n">do_unroll</span>
                      <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Chebyshev reaction</span>
    <span class="n">tlim_inv_sum</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tlim_inv_sub</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
            <span class="s1">&#39;Tred = ((2.0 / T) - &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;{:.16e}) / {:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tlim_inv_sum</span><span class="p">,</span> <span class="n">tlim_inv_sub</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="n">plim_log_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>
    <span class="n">plim_log_sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
            <span class="s1">&#39;Pred = (2.0 * log10(pres) - &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;{:.16e}) / {:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plim_log_sum</span><span class="p">,</span> <span class="n">plim_log_sub</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="c1">#do U(T) sum</span>
    <span class="n">write_cheb_ut</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>

    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;kf * ({:.16e} / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">tlim_inv_sub</span><span class="p">)</span>

    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * (&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
        <span class="c1"># reverse reaction rate also</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">)</span>

    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; * {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * (&#39;</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;{} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;-T * (&#39;</span> <span class="o">+</span> <span class="n">get_db_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">do_unroll</span><span class="p">)</span>
        <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;))&#39;</span>

    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)) * rho_inv&#39;</span>
    <span class="c1"># print line for reaction</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jline</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span></div>


<div class="viewcode-block" id="write_plog_rxn_dt"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_plog_rxn_dt">[docs]</a><span class="k">def</span> <span class="nf">write_plog_rxn_dt</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">jline</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span>
                      <span class="n">rev_idx</span><span class="p">,</span> <span class="n">get_array</span><span class="p">,</span> <span class="n">do_unroll</span>
                      <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Plog reactions have conditional contribution,</span>
    <span class="c1"># depends on pressure range</span>

    <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">A_p1</span><span class="p">,</span> <span class="n">b_p1</span><span class="p">,</span> <span class="n">E_p1</span><span class="p">)</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># For pressure below the first pressure given, use standard</span>
    <span class="c1"># Arrhenius expression.</span>

    <span class="c1"># Make copy, but with specific pressure Arrhenius coefficients</span>
    <span class="n">rxn_p</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">ReacInfo</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">,</span>
                          <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">,</span>
                          <span class="n">A_p1</span><span class="p">,</span> <span class="n">b_p1</span><span class="p">,</span> <span class="n">E_p1</span>
                          <span class="p">)</span>

    <span class="n">dkdt</span> <span class="o">=</span> <span class="n">get_elementary_rxn_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn_p</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span>
                                 <span class="n">rev_idx</span><span class="p">,</span> <span class="n">get_array</span><span class="p">,</span> <span class="n">do_unroll</span>
                                 <span class="p">)</span>
    <span class="n">have_prev</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">dkdt</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;if (pres &lt;= {:.4e}) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">jline</span> <span class="o">+</span> <span class="n">dkdt</span><span class="p">)</span>
        <span class="n">have_prev</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">A_p1</span><span class="p">,</span> <span class="n">b_p1</span><span class="p">,</span> <span class="n">E_p1</span><span class="p">)</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">A_p2</span><span class="p">,</span> <span class="n">b_p2</span><span class="p">,</span> <span class="n">E_p2</span><span class="p">)</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">jline_p</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">A_p2</span> <span class="o">/</span> <span class="n">A_p1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># MIT mechanisms occasionally have (for some unknown reason)</span>
            <span class="c1"># negative A&#39;s, so we need to handle the</span>
            <span class="c1"># log(K2) - log(K1) term differently</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">b_p1</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">E_p1</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">b_p2</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">E_p2</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;PLOG Derivative undefined&quot;</span>
            <span class="k">if</span> <span class="n">b_p1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_p1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">E_p1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jline_p</span><span class="p">:</span> <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
                <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e} / T&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E_p1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b_p2</span> <span class="o">-</span> <span class="n">b_p1</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">E_p2</span> <span class="o">-</span> <span class="n">E_p1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jline_p</span><span class="p">:</span> <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

                <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span>
                <span class="k">if</span> <span class="n">b_p2</span> <span class="o">-</span> <span class="n">b_p1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_p2</span> <span class="o">-</span> <span class="n">b_p1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">E_p2</span> <span class="o">-</span> <span class="n">E_p1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e} / T) * (log(pres)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E_p2</span> <span class="o">-</span> <span class="n">E_p1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39; - {:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
                    <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;) / &#39;</span>
                    <span class="k">assert</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">,</span> <span class="s1">&#39;Cannot have equal pressures in PLOG&#39;</span>
                    <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;{:.16e})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

            <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39; * (&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
                <span class="c1"># reverse reaction rate also</span>
                <span class="n">jline_p</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; - &#39;</span> <span class="o">+</span>
                            <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">)</span>
                            <span class="p">)</span>
            <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jline_p</span><span class="p">:</span> <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
            <span class="n">jline_p</span> <span class="o">+=</span> <span class="p">(</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39; * {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">nu</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">)</span>
            <span class="n">dbdt</span> <span class="o">=</span> <span class="n">get_db_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">do_unroll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">dbdt</span><span class="p">:</span>
                <span class="n">jline_p</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; - &#39;</span> <span class="k">if</span> <span class="n">jline_p</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span>
                            <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_idx</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s1">&#39; * (&#39;</span>
                            <span class="p">)</span>
                <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;{} + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">nu</span><span class="p">)</span>
                <span class="n">dbdt</span> <span class="o">=</span> <span class="n">get_db_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">do_unroll</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dbdt</span><span class="p">:</span>
                    <span class="n">jline_p</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;-T * (&#39;</span> <span class="o">+</span>
                                <span class="n">get_db_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">do_unroll</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s1">&#39;)&#39;</span>
                                <span class="p">)</span>
                <span class="n">jline_p</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="k">if</span> <span class="n">jline_p</span><span class="p">:</span>
            <span class="n">jline_p</span> <span class="o">=</span> <span class="n">jline</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">jline_p</span> <span class="o">+</span> <span class="s1">&#39;)) * rho_inv&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jline_p</span> <span class="o">=</span> <span class="n">jline</span> <span class="o">+</span> <span class="s1">&#39;0.0e0)&#39;</span>

        <span class="k">if</span> <span class="n">have_prev</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;}} else if ((pres &gt; {:.4e}) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;&amp;&amp; (pres &lt;= {:.4e})) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;if ((pres &gt; {:.4e}) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;&amp;&amp; (pres &lt;= {:.4e})) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">have_prev</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># print line for reaction</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">jline_p</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="n">A_pn</span><span class="p">,</span> <span class="n">b_pn</span><span class="p">,</span> <span class="n">E_pn</span><span class="p">)</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># For pressure above the final pressure given, use standard</span>
    <span class="c1"># Arrhenius expression.</span>

    <span class="c1"># Make copy, but with specific pressure Arrhenius coefficients</span>
    <span class="n">rxn_p</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">ReacInfo</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">,</span>
                          <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">,</span>
                          <span class="n">A_pn</span><span class="p">,</span> <span class="n">b_pn</span><span class="p">,</span> <span class="n">E_pn</span>
                          <span class="p">)</span>
    <span class="n">dkdt</span> <span class="o">=</span> <span class="n">get_elementary_rxn_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn_p</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span>
                                 <span class="n">rev_idx</span><span class="p">,</span> <span class="n">get_array</span><span class="p">,</span> <span class="n">do_unroll</span>
                                 <span class="p">)</span>
    <span class="k">if</span> <span class="n">dkdt</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">have_prev</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;}} else if (pres &gt; {:.4e}) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;j_temp = 0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;if (pres &gt; {:.4e}) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">jline</span> <span class="o">+</span> <span class="n">dkdt</span><span class="p">)</span>

        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_dt_y"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dt_y">[docs]</a><span class="k">def</span> <span class="nf">write_dt_y</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">isp</span><span class="p">,</span> <span class="n">num_s</span><span class="p">,</span>
               <span class="n">touched</span><span class="p">,</span> <span class="n">get_array</span>
               <span class="p">):</span>
    <span class="k">for</span> <span class="n">k_sp</span><span class="p">,</span> <span class="n">sp_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="n">lin_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">lin_index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39; +&#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">lin_index</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; -(&#39;</span>
                     <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {}= -(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">lin_index</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">touched</span><span class="p">[</span><span class="n">lin_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * (&#39;</span>
                     <span class="s1">&#39;&#39;</span> <span class="o">+</span>
                     <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                     <span class="s1">&#39; * cp_avg * rho&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39; - (&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span>
                     <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39; * {:.8e}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                     <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * (&#39;</span>
                     <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39; * cp_avg * rho&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39; - (&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span>
                     <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39; * {:.8e}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                     <span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_dt_y_division"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dt_y_division">[docs]</a><span class="k">def</span> <span class="nf">write_dt_y_division</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">num_s</span><span class="p">,</span> <span class="n">get_array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;Complete dT/dy calculations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;j_temp = 1.0 / (rho * cp_avg * cp_avg)&#39;</span> <span class="o">+</span>
               <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
               <span class="p">)</span>
    <span class="k">for</span> <span class="n">k_sp</span><span class="p">,</span> <span class="n">sp_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="n">lin_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">lin_index</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; *= (j_temp)&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;= &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * (j_temp)&#39;</span>

        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_dt_completion"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dt_completion">[docs]</a><span class="k">def</span> <span class="nf">write_dt_completion</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">J_nplusone_touched</span><span class="p">,</span> <span class="n">get_array</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;Complete dT wrt T calculations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = -(&#39;</span>

    <span class="k">for</span> <span class="n">k_sp</span><span class="p">,</span> <span class="n">sp_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k_sp</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;  + &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39; * {:.8e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_k</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span>
                 <span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(-working_temp * &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39; / cp_avg + &#39;</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                 <span class="p">)</span>
        <span class="k">if</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">j_str</span> <span class="o">=</span> <span class="s1">&#39;J_nplusone&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">j_str</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">J_nplusone_touched</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">j_str</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span>
                     <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * rho&#39;</span>
                     <span class="p">)</span>
        <span class="k">if</span> <span class="n">k_sp</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; &amp;&#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;) / (rho * cp_avg)&#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_sub_intro"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_sub_intro">[docs]</a><span class="k">def</span> <span class="nf">write_sub_intro</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">rate_list</span><span class="p">,</span> <span class="n">this_rev</span><span class="p">,</span> <span class="n">this_pdep</span><span class="p">,</span>
                    <span class="n">have_pres_mod_temp</span><span class="p">,</span>
                    <span class="n">batch_has_m</span><span class="p">,</span> <span class="n">this_thd</span><span class="p">,</span> <span class="n">this_troe</span><span class="p">,</span> <span class="n">this_sri</span><span class="p">,</span>
                    <span class="n">this_cheb</span><span class="p">,</span> <span class="n">cheb_dim</span><span class="p">,</span> <span class="n">this_plog</span><span class="p">,</span> <span class="n">no_shared</span><span class="p">,</span> <span class="n">has_nsp</span>
                    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the header and definitions for of any of the various sub-functions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : str {&#39;c&#39;, &#39;cuda&#39;}</span>
<span class="sd">        Programming language</span>
<span class="sd">    number : int</span>
<span class="sd">        Jacobian file number</span>
<span class="sd">    rate_list :</span>
<span class="sd">    this_rev :</span>
<span class="sd">    this_pdep :</span>
<span class="sd">    have_pres_mod_temp :</span>
<span class="sd">    batch_has_m :</span>
<span class="sd">    this_thd :</span>
<span class="sd">    this_troe :</span>
<span class="sd">    this_sri :</span>
<span class="sd">    this_cheb :</span>
<span class="sd">    cheb_dim :</span>
<span class="sd">    this_plog :</span>
<span class="sd">    no_shared :</span>
<span class="sd">    has_nsp :</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    file : file object</span>
<span class="sd">        Opened Jacobian file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacob_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
              <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span>
              <span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef JACOB_HEAD_{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;#define JACOB_HEAD_{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;#include &quot;../header{}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;__device__ &#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;&#39;</span>
                   <span class="s1">&#39;void eval_jacob_{} (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
                   <span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;const double, const double * {0}&#39;</span>
        <span class="k">for</span> <span class="n">rate</span> <span class="ow">in</span> <span class="n">rate_list</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, const double * {0}&#39;</span>
        <span class="k">if</span> <span class="n">batch_has_m</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, const double&#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;, const double, const double&#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">this_rev</span> <span class="k">else</span> <span class="s1">&#39;, const double * {0}&#39;</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39;, const double, double * {0}&#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, double * {0}, double* {0}&#39;</span> <span class="k">if</span> <span class="n">has_nsp</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, double * {0}&#39;</span> <span class="k">if</span> <span class="n">this_cheb</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39;);</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacob_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span>
                <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &lt;math.h&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#include &quot;../header{}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span>  <span class="s1">&#39;__device__ &#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;void eval_jacob_{} (const double pres, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
             <span class="s1">&#39;const double * {0} conc&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rate</span> <span class="ow">in</span> <span class="n">rate_list</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, const double * {0} &#39;</span> <span class="o">+</span> <span class="n">rate</span>
    <span class="k">if</span> <span class="n">batch_has_m</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, const double m&#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, const double mw_avg, const double rho&#39;</span>
    <span class="k">if</span> <span class="n">this_rev</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, const double * {0} dBdT&#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, const double T, double * {0} jac&#39;</span>

    <span class="k">if</span> <span class="n">has_nsp</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, double * {0} J_nplusone, double * {0} J_nplusjplus&#39;</span>
    <span class="k">if</span> <span class="n">this_cheb</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, double * {0} dot_prod&#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;) {{&#39;</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_shared</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;extern __shared__ double shared_temp[]&#39;</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                   <span class="p">)</span>
        <span class="c1"># third-body variable needed for reactions</span>
    <span class="k">if</span> <span class="n">this_pdep</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;conc_temp&#39;</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


    <span class="c1"># log(T)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;logT = log(T)&#39;</span> <span class="o">+</span>
             <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
             <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;kf = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;j_temp = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">have_pres_mod_temp</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;pres_mod_temp = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># if any reverse reactions, will need Kc</span>
    <span class="k">if</span> <span class="n">this_rev</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;Kc = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;kr = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># pressure-dependence variables</span>
    <span class="k">if</span> <span class="n">this_pdep</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;Pr = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">this_troe</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;double {} = 0.0{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                       <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;Fcent&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;lnF_AB&#39;</span><span class="p">]</span>
                       <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">this_sri</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double X = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">this_cheb</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double Tred, Pred&#39;</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                   <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double cheb_temp_0, cheb_temp_1&#39;</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                   <span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double dot_prod[{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cheb_dim</span><span class="p">)</span> <span class="o">+</span>
                            <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">this_plog</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double kf2&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double rho_inv = 1.0 / rho&#39;</span> <span class="o">+</span>
               <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
               <span class="p">)</span>

    <span class="k">return</span> <span class="nb">file</span></div>


<div class="viewcode-block" id="write_dy_intros"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_dy_intros">[docs]</a><span class="k">def</span> <span class="nf">write_dy_intros</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">have_jnplus_jplus</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacob_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
              <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span>
              <span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef JACOB_HEAD_{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;#define JACOB_HEAD_{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;#include &quot;../header{}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                   <span class="p">(</span><span class="s1">&#39;__device__ &#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;void eval_jacob_{} (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
                   <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;const double, const double, const double, const double*, &#39;</span>
                   <span class="s1">&#39;const double*, const double*, double*&#39;</span>
                   <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;, double*&#39;</span> <span class="k">if</span> <span class="n">have_jnplus_jplus</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacob_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span>
                <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;../header{}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;__device__ &#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span>
        <span class="s1">&#39;void eval_jacob_{} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span>
        <span class="s1">&#39;(const double mw_avg, const double rho, &#39;</span>
        <span class="s1">&#39;const double cp_avg, const double* spec_rates, &#39;</span>
        <span class="s1">&#39;const double* h, const double* cp, double* jac&#39;</span> <span class="o">+</span>
        <span class="p">(</span><span class="s1">&#39;, double* J_nplusjplus&#39;</span> <span class="k">if</span> <span class="n">have_jnplus_jplus</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="s1">&#39;) &#39;</span>
        <span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;{</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register &#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double rho_inv = 1.0 / rho&#39;</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double working_temp = (1.0 / cp_avg)&#39;</span> <span class="o">+</span>
               <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
               <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double j_temp = 1.0 / &#39;</span>
               <span class="s1">&#39;(rho * cp_avg * cp_avg)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
               <span class="p">)</span>

    <span class="k">return</span> <span class="nb">file</span></div>


<div class="viewcode-block" id="write_jacobian"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_jacobian">[docs]</a><span class="k">def</span> <span class="nf">write_jacobian</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">seen_sp</span><span class="p">,</span> <span class="n">smm</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write Jacobian subroutine in desired language.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : str {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Programming language.</span>
<span class="sd">    specs : list of SpecInfo</span>
<span class="sd">        List of species in the mechanism.</span>
<span class="sd">    reacs : list of ReacInfo</span>
<span class="sd">        List of reactions in the mechanism.</span>
<span class="sd">    seen_sp : list of bool</span>
<span class="sd">        List of booleans, False if species i has an (identically) zero species rate</span>
<span class="sd">    smm : shared_memory_manager, optional</span>
<span class="sd">        If not ``None``, use this to manage shared memory optimization</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">do_unroll</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">Jacob_Unroll</span>
        <span class="n">unroll_len</span> <span class="o">=</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">Jacob_Unroll</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">Max_Lines</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">do_unroll</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CParams</span><span class="o">.</span><span class="n">Jacob_Unroll</span>
        <span class="n">unroll_len</span> <span class="o">=</span> <span class="n">CParams</span><span class="o">.</span><span class="n">Jacob_Unroll</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">CParams</span><span class="o">.</span><span class="n">Max_Lines</span>
    <span class="k">if</span> <span class="n">do_unroll</span><span class="p">:</span>
        <span class="c1"># make paths for separate jacobian files</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacobs&#39;</span><span class="p">))</span>

    <span class="c1"># first write header file</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacob&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef JACOB_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#define JACOB_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#include &quot;header{0}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
               <span class="p">(</span><span class="s1">&#39;#include &#39;</span>
                <span class="s1">&#39;&quot;jacobs/jac_include{0}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">do_unroll</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
               <span class="s1">&#39;#include &quot;chem_utils{0}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#include &quot;rates{0}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
               <span class="s1">&#39;#include &quot;gpu_memory.cuh&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;__device__ &#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;void eval_jacob (const double, const double, &#39;</span>
               <span class="s1">&#39;const double * {0}, double * {0}{1});</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span>
                <span class="s1">&#39;, const mechanism_memory * {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
               <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># numbers of species and reactions</span>
    <span class="n">num_s</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
    <span class="n">num_r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span>
    <span class="n">rev_reacs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">]</span>
    <span class="n">num_rev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_reacs</span><span class="p">)</span>

    <span class="n">pdep_reacs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body</span> <span class="ow">or</span> <span class="n">reac</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
            <span class="c1"># add reaction index to list</span>
            <span class="n">pdep_reacs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">num_pdep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdep_reacs</span><span class="p">)</span>

    <span class="c1"># create file depending on language</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;jacob&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="c1"># header files</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;jacob{}&quot;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;__device__ &#39;</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;void eval_jacob (const double t, const double pres, &#39;</span>
                 <span class="s1">&#39;const double * {0} y, double * {0} jac{1}) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span>
                 <span class="s1">&#39;, const mechanism_memory * {} d_mem&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;subroutine eval_jacob (t, pres, y, jac)</span><span class="se">\n\n</span><span class="s1">&#39;</span>

        <span class="c1"># fortran needs type declarations</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  integer, parameter :: wp = kind(1.0d0)&#39;</span>
                 <span class="s1">&#39;  real(wp), intent(in) :: t, pres, y({})</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;  real(wp), intent(out) :: jac({0},{0})</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;  </span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  real(wp) :: T, rho, cp_avg, logT</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">reacs</span><span class="p">[</span><span class="n">rxn</span><span class="p">]</span><span class="o">.</span><span class="n">thd_body</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">rev_reacs</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  real(wp) :: m</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  real(wp), dimension({}) :: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;conc, cp, h, dy</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  real(wp), dimension({}) :: rxn_rates</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_r</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;  real(wp), dimension({}) :: pres_mod</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_pdep</span><span class="p">)</span>
                 <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;function jac = eval_jacob (T, pres, y)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">get_array</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">get_array</span> <span class="o">=</span> <span class="n">smm</span><span class="o">.</span><span class="n">get_array</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">write_init</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># get temperature</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double T = &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;T = &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
               <span class="s1">&#39; average molecular weight</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
    <span class="c1"># calculation of average molecular weight</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double mw_avg;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
               <span class="s1">&#39; mass-averaged density</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double rho;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># evaluate species molar concentrations</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
               <span class="s1">&#39; species molar concentrations</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double conc[{}];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double * {} conc = d_mem-&gt;conc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;conc = zeros({},1);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span>
                   <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double y_N&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;eval_conc(&#39;</span> <span class="o">+</span>
               <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
               <span class="s1">&#39;, pres, &amp;&#39;</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span>
                <span class="s1">&#39;y[GRID_DIM]&#39;</span><span class="p">)</span> <span class="o">+</span>
               <span class="s1">&#39;, &amp;y_N, &amp;mw_avg, &amp;rho, conc)&#39;</span> <span class="o">+</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>

    <span class="n">rate_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fwd_rates&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_reacs</span><span class="p">):</span>
        <span class="n">rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rev_rates&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdep_reacs</span><span class="p">):</span>
        <span class="n">rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">)</span>
    <span class="n">rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;spec_rates&#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
               <span class="s1">&#39; evaluate reaction rates</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>

    <span class="n">cuda_cheb</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span>
    <span class="c1"># evaluate forward and reverse reaction rates</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                <span class="s1">&#39;double * {} fwd_rates = d_mem-&gt;fwd_rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double fwd_rates[{}];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_r</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">num_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double* rev_rates = 0;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                <span class="s1">&#39;double * {} rev_rates = d_mem-&gt;rev_rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;double rev_rates[{}];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_rev</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="k">if</span> <span class="n">cuda_cheb</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * {} dot_prod = d_mem-&gt;dot_prod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;eval_rxn_rates (T, pres, conc, fwd_rates, &#39;</span>
                   <span class="s1">&#39;rev_rates{});</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, dot_prod&#39;</span> <span class="k">if</span> <span class="n">cuda_cheb</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;call eval_rxn_rates (T, pres, conc, fwd_rates, &#39;</span>
                       <span class="s1">&#39;rev_rates)</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;[fwd_rates, rev_rates] = eval_rxn_rates &#39;</span>
                   <span class="s1">&#39;(T, pres, conc);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_pdep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double* pres_mod = 0;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;double pres_mod[{}];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_pdep</span><span class="p">)</span>
                   <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;double * {} pres_mod = d_mem-&gt;pres_mod{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="p">)</span>



    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdep_reacs</span><span class="p">):</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
                   <span class="s1">&#39;get pressure modifications to reaction rates</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
        <span class="c1"># evaluate third-body and pressure-dependence reaction modifications</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;get_rxn_pres_mod (T, pres, conc, pres_mod);</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;call get_rxn_pres_mod (T, pres, conc, pres_mod)</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;pres_mod = get_rxn_pres_mod (T, pres, conc, &#39;</span>
                       <span class="s1">&#39;pres_mod);</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># evaluate species rates</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
               <span class="s1">&#39; evaluate rate of change of species molar concentration</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;double spec_rates[{}] = {{0}};</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">))</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
            <span class="s1">&#39;eval_spec_rates (fwd_rates, rev_rates, &#39;</span>
            <span class="s1">&#39;pres_mod, spec_rates, &amp;spec_rates[{}]);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;double * {} spec_rates = d_mem-&gt;spec_rates{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
            <span class="s1">&#39;eval_spec_rates (fwd_rates, rev_rates, &#39;</span>
            <span class="s1">&#39;pres_mod, spec_rates, &amp;{}){}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">num_s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;call eval_spec_rates (fwd_rates, rev_rates, &#39;</span>
                   <span class="s1">&#39;pres_mod, spec_rates, spec_rates({}))</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;spec_rates = eval_spec_rates(fwd_rates, &#39;</span>
                   <span class="s1">&#39;rev_rates, pres_mod);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># third-body variable needed for reactions</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;m = pres / ({:.8e} * T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_unroll</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
            <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;conc_temp&#39;</span> <span class="o">+</span>
                     <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                     <span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


    <span class="c1"># log(T)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;logT = log(T)&#39;</span> <span class="o">+</span>
             <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
             <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_unroll</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;j_temp = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;kf = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">)</span> <span class="ow">and</span>
               <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep_sp</span><span class="p">)</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
            <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;pres_mod_temp = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># if any reverse reactions, will need Kc</span>
        <span class="k">if</span> <span class="n">rev_reacs</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
            <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;Kc = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;kr = 0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

        <span class="c1"># pressure-dependence variables</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
            <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;Pr = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">troe</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;  double {} = 0.0{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;Fcent&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;lnF_AB&#39;</span>
                <span class="p">])</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sri</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double X = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">):</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;double Tred, Pred&#39;</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;double cheb_temp_0, cheb_temp_1&#39;</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="p">(</span><span class="s1">&#39;double dot_prod[{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span>
                       <span class="k">else</span> <span class="s1">&#39;double * {} dot_prod = d_mem-&gt;dot_prod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">plog</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">):</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double kf2&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;rho_inv = 1.0 / rho&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">reac</span><span class="o">.</span><span class="n">prod</span><span class="p">)</span> <span class="ow">and</span> \
        <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reac</span><span class="p">)</span> <span class="k">for</span> <span class="n">reac</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">):</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
           <span class="s1">&#39;double J_nplusone = 0&#39;</span> <span class="o">+</span>
           <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
           <span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;double J_nplusjplus[NSP]&#39;</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                       <span class="s1">&#39;double * {} J_nplusjplus = d_mem-&gt;J_nplusjplus&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>

    <span class="c1"># variables for equilibrium constant derivatives, if needed</span>
    <span class="n">dBdT_flag</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>

    <span class="c1"># define dB/dT&#39;s</span>
    <span class="n">write_db_dt_def</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span> <span class="n">dBdT_flag</span><span class="p">,</span> <span class="n">do_unroll</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1">###################################</span>
    <span class="c1"># now begin Jacobian evaluation</span>
    <span class="c1">###################################</span>
    <span class="c1">###################################</span>
    <span class="c1"># partial derivatives of reactions</span>
    <span class="c1">###################################</span>
    <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">retry</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">smm</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="c1"># whether this jacobian index has been modified</span>
        <span class="n">touched</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))]</span>
        <span class="n">J_nplusone_touched</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">J_nplusjplus_touched</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))]</span>

        <span class="n">batch_has_thd</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">last_conc_temp</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">jac_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">next_fn_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">rind</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">do_unroll</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rind</span> <span class="o">==</span> <span class="n">next_fn_index</span><span class="p">):</span>
                <span class="c1"># clear conc temp</span>
                <span class="n">last_conc_temp</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">retry</span><span class="p">:</span>
                    <span class="n">file_store</span> <span class="o">=</span> <span class="nb">file</span>
                <span class="n">retry</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c1"># get next index</span>
                <span class="n">next_fn_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rind</span> <span class="o">+</span> <span class="n">unroll_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">))</span>
                <span class="c1"># get flags</span>
                <span class="n">rev</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">pdep</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">thd</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">troe</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">sri</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">cheb</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">plog</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">pdep_thd_eff</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">has_jnplus_one</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">batch_has_m</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">have_pres_mod_temp</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">ind_next</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rind</span><span class="p">,</span> <span class="n">next_fn_index</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
                        <span class="n">rev</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
                        <span class="n">pdep</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">:</span>
                            <span class="n">pdep_thd_eff</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">batch_has_m</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">thd_body</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">thd_body_eff</span> <span class="ow">or</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">pdep_sp</span><span class="p">)):</span>
                        <span class="n">have_pres_mod_temp</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">thd_body</span><span class="p">:</span>
                        <span class="n">thd</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">troe</span><span class="p">:</span>
                        <span class="n">troe</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">sri</span><span class="p">:</span>
                        <span class="n">sri</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">cheb</span><span class="p">:</span>
                        <span class="n">cheb</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span><span class="o">.</span><span class="n">plog</span><span class="p">:</span>
                        <span class="n">plog</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">reac</span> <span class="o">=</span> <span class="n">reacs</span><span class="p">[</span><span class="n">ind_next</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">reac</span><span class="o">.</span><span class="n">prod</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reac</span><span class="p">):</span>
                        <span class="n">has_jnplus_one</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="n">dim</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">cheb</span><span class="p">:</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span><span class="p">)</span>
                <span class="c1"># write the specific evaluator for this reaction</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="n">write_sub_intro</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacobs&#39;</span><span class="p">),</span> <span class="n">lang</span><span class="p">,</span>
                                       <span class="n">jac_count</span><span class="p">,</span> <span class="n">rate_list</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">pdep</span><span class="p">,</span>
                                       <span class="n">have_pres_mod_temp</span><span class="p">,</span>
                                       <span class="n">batch_has_m</span><span class="p">,</span> <span class="n">thd</span><span class="p">,</span> <span class="n">troe</span><span class="p">,</span> <span class="n">sri</span><span class="p">,</span> <span class="n">cheb</span><span class="p">,</span>
                                       <span class="n">dim</span><span class="p">,</span> <span class="n">plog</span><span class="p">,</span> <span class="n">smm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span>
                                       <span class="n">has_jnplus_one</span>
                                       <span class="p">)</span>

            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">variable_list</span><span class="p">,</span> <span class="n">usages</span> <span class="o">=</span> <span class="n">calculate_shared_memory</span><span class="p">(</span><span class="n">rind</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span>
                                                                <span class="n">reacs</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span>
                                                                <span class="n">pdep_reacs</span>
                                                                <span class="p">)</span>
                <span class="n">smm</span><span class="o">.</span><span class="n">load_into_shared</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">variable_list</span><span class="p">,</span> <span class="n">usages</span><span class="p">)</span>


            <span class="c1">######################################</span>
            <span class="c1"># with respect to temperature</span>
            <span class="c1">######################################</span>

            <span class="n">write_dt_comment</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>

            <span class="c1"># first we need any pres mod terms</span>
            <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">pind</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
                <span class="n">pind</span> <span class="o">=</span> <span class="n">pdep_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span>
                <span class="n">last_conc_temp</span> <span class="o">=</span> <span class="n">write_pr</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">pdep_reacs</span><span class="p">,</span>
                                          <span class="n">rxn</span><span class="p">,</span> <span class="n">get_array</span><span class="p">,</span> <span class="n">last_conc_temp</span>
                                          <span class="p">)</span>

                <span class="c1"># dF/dT</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">troe</span><span class="p">:</span>
                    <span class="n">write_troe</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">sri</span><span class="p">:</span>
                    <span class="n">write_sri</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>

                <span class="n">jline</span> <span class="o">=</span> <span class="n">get_pdep_dt</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span> <span class="n">pind</span><span class="p">,</span> <span class="n">get_array</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span><span class="p">:</span>
                <span class="c1"># third body reaction</span>
                <span class="n">pind</span> <span class="o">=</span> <span class="n">pdep_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span>

                <span class="n">jline</span> <span class="o">=</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                         <span class="s1">&#39;j_temp = ((-&#39;</span> <span class="o">+</span>
                         <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s1">&#39; * &#39;</span>
                         <span class="p">)</span>

                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
                    <span class="c1"># forward and reverse reaction rates</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> \
                        <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">))</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># forward reaction rate only</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>

                <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; / T) + (&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;  j_temp = ((1.0&#39;</span>
                <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">]:</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39;  j_temp = ((1.0_wp&#39;</span>

            <span class="n">jline</span> <span class="o">+=</span> <span class="s1">&#39; / T) * (&#39;</span>

            <span class="n">doT</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog</span><span class="p">:</span>
                <span class="n">write_plog_rxn_dt</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">jline</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span>
                                  <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                                  <span class="n">get_array</span><span class="p">,</span> <span class="n">do_unroll</span>
                                  <span class="p">)</span>

            <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span><span class="p">:</span>
                <span class="n">write_cheb_rxn_dt</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">jline</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span>
                                  <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                                  <span class="n">specs</span><span class="p">,</span> <span class="n">get_array</span><span class="p">,</span> <span class="n">do_unroll</span>
                                  <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">dkdt</span> <span class="o">=</span> <span class="n">get_elementary_rxn_dt</span><span class="p">(</span>
                    <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span>
                    <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">get_array</span><span class="p">,</span> <span class="n">do_unroll</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">dkdt</span><span class="p">:</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jline</span> <span class="o">+</span> <span class="n">dkdt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">doT</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">doT</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k_sp</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
                    <span class="n">sp_k</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">k_sp</span><span class="p">]</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
                    <span class="n">nu</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="n">k_sp</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                        <span class="n">j_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;{}J_nplusone&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">do_unroll</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">num_s</span>
                                 <span class="k">else</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                 <span class="p">)</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">j_str</span> <span class="o">+</span>
                            <span class="s1">&#39; {}= {}j_temp{} * {:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                <span class="s1">&#39; * {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">sp_k</span><span class="o">.</span><span class="n">mw</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                        <span class="c1"># NOTE: I believe there was a bug here w/ the previous</span>
                        <span class="c1"># fortran/matlab code (as it looks like it would be zero</span>
                        <span class="c1"># indexed)</span>
                        <span class="n">j_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;J_nplusone&#39;</span> <span class="k">if</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">num_s</span>
                                 <span class="k">else</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                 <span class="p">)</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">j_str</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>
                            <span class="p">(</span><span class="n">j_str</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s1">&#39; {}j_temp{} * {:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span>
                                <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                <span class="s1">&#39; * {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sp_k</span><span class="o">.</span><span class="n">mw</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">num_s</span><span class="p">:</span>
                        <span class="n">J_nplusone_touched</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">touched</span><span class="p">[</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1">######################################</span>
            <span class="c1"># with respect to species</span>
            <span class="c1">######################################</span>
            <span class="n">write_dy_comment</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">:</span>
                <span class="c1"># need to find Kc</span>
                <span class="n">write_kc</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>

            <span class="c1"># need to write the dr/dy parts (independent of any species)</span>
            <span class="n">write_dr_dy</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rev_reacs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span>
                        <span class="n">pind</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span> <span class="n">get_array</span>
                        <span class="p">)</span>

            <span class="c1"># write the forward / backwards rates:</span>
            <span class="n">write_rates</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>

            <span class="c1"># now loop through each species</span>
            <span class="k">for</span> <span class="n">j_sp</span><span class="p">,</span> <span class="n">sp_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dr_dyj</span> <span class="o">=</span> <span class="n">write_dr_dy_species</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">pind</span><span class="p">,</span>
                                                        <span class="n">j_sp</span><span class="p">,</span> <span class="n">sp_j</span><span class="p">,</span> <span class="n">rind</span><span class="p">,</span>
                                                        <span class="n">rev_reacs</span><span class="p">,</span> <span class="n">get_array</span>
                                                        <span class="p">)</span>
                <span class="k">for</span> <span class="n">k_sp</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
                    <span class="n">sp_k</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">k_sp</span><span class="p">]</span>

                    <span class="n">nu</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="n">k_sp</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">jline</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
                    <span class="k">if</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num_s</span><span class="p">:</span>
                        <span class="n">lin_index</span> <span class="o">=</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">j_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="c1">#if not rind in thelist and lin_index == 30608:</span>
                        <span class="c1">#    thelist.add(rind)</span>
                        <span class="c1"># sparse indexes</span>
                        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                            <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span>
                                  <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">lin_index</span><span class="p">)</span> <span class="o">+</span>
                                  <span class="s1">&#39; {}= &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">lin_index</span><span class="p">]</span>
                                  <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                  <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                            <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span>
                                  <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">j_sp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                  <span class="p">(</span><span class="s1">&#39; = &#39;</span> <span class="o">+</span>
                                  <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">j_sp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                  <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                                  <span class="s1">&#39; + &#39;</span>
                                  <span class="p">)</span>

                        <span class="n">touched</span><span class="p">[</span><span class="n">lin_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                            <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;J_nplusjplus&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s1">&#39; {}= &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">J_nplusjplus_touched</span><span class="p">[</span><span class="n">j_sp</span><span class="p">]</span>
                                               <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                                               <span class="p">)</span>
                                <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                            <span class="n">jline</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;J_nplusjplus&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span> <span class="o">+</span>
                                <span class="p">(</span><span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;J_nplusjplus&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">J_nplusjplus_touched</span><span class="p">[</span><span class="n">j_sp</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span>
                                <span class="p">)</span>

                        <span class="n">J_nplusjplus_touched</span><span class="p">[</span><span class="n">j_sp</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="n">working_temp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">mw_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp_k</span><span class="o">.</span><span class="n">mw</span> <span class="o">/</span> <span class="n">sp_j</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mw_frac</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">working_temp</span> <span class="o">+=</span> <span class="s1">&#39; -&#39;</span>
                    <span class="k">elif</span> <span class="n">mw_frac</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">working_temp</span> <span class="o">+=</span> <span class="s1">&#39; {:.16e} * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mw_frac</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">working_temp</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

                    <span class="n">working_temp</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span>

                    <span class="n">working_temp</span> <span class="o">+=</span> <span class="n">dr_dyj</span>

                    <span class="n">working_temp</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

                    <span class="n">jline</span> <span class="o">+=</span> <span class="n">working_temp</span>
                    <span class="n">jline</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>

                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jline</span><span class="p">)</span>
                    <span class="n">jline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">evictable</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variable_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">base</span> <span class="o">==</span> <span class="s1">&#39;conc&#39;</span><span class="p">]</span>
                <span class="n">smm</span><span class="o">.</span><span class="n">mark_for_eviction</span><span class="p">(</span><span class="n">evictable</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">do_unroll</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rind</span> <span class="o">==</span> <span class="n">next_fn_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">rind</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># switch back</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="n">file_store</span>
                <span class="c1">#test file size for CUDA</span>
                <span class="c1">#to avoid killing nvcc</span>
                <span class="k">if</span> <span class="n">jac_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacobs&#39;</span><span class="p">,</span> <span class="s1">&#39;jacob_{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jac_count</span><span class="p">,</span>
                                <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])))</span> <span class="k">as</span> <span class="n">readfile</span><span class="p">:</span>
                        <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">readfile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">num_lines</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
                        <span class="n">unroll_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unroll_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">retry</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">break</span>

                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_jacob_{}(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jac_count</span><span class="p">))</span>
                <span class="n">jac_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pres, conc&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">rate</span> <span class="ow">in</span> <span class="n">rate_list</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">rate</span>
                <span class="k">if</span> <span class="n">batch_has_m</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, m&#39;</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, mw_avg, rho&#39;</span>
                <span class="k">if</span> <span class="n">rev</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, dBdT&#39;</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, T, jac&#39;</span>
                <span class="k">if</span> <span class="n">has_jnplus_one</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, &amp;J_nplusone, J_nplusjplus&#39;</span>
                <span class="k">if</span> <span class="n">cheb</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, dot_prod&#39;</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">rind</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1">###################################</span>
    <span class="c1"># Partial derivatives of temperature (energy equation)</span>
    <span class="c1">###################################</span>

    <span class="c1"># evaluate enthalpy</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // species enthalpies</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double h[{}];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;  eval_h(T, h);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // species enthalpies</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double * {} h = d_mem-&gt;h;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                   <span class="s1">&#39;  eval_h(T, h);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! species enthalpies</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  call eval_h(T, h)</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">% s</span><span class="s1">pecies enthalpies</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  h = eval_h(T);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># evaluate specific heat</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // species specific heats</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double cp[{}];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;  eval_cp(T, cp);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // species specific heats</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double * {} cp = d_mem-&gt;cp;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                   <span class="s1">&#39;  eval_cp(T, cp);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! species specific heats</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  call eval_cp(T, cp)</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">% s</span><span class="s1">pecies specific heats</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  cp = eval_cp(T);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># average specific heat</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // average specific heat</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double cp_avg;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // average specific heat</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  register double cp_avg;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! average specific heat</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  % average specific heat</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;cp_avg = &#39;</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; &amp;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; ...</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;   &#39;</span>

        <span class="n">isp</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                 <span class="s1">&#39; + &#39;</span>
                 <span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;y_N&#39;</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span>
             <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
             <span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># set jac[0] = 0</span>
    <span class="c1"># set to zero</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = 0.0&#39;</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = 0.0_wp&#39;</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = 0.0&#39;</span>
    <span class="n">touched</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_unroll</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;double &#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;register double &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;working_temp = (1.0 / cp_avg)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;j_temp = 1.0 / (rho * cp_avg * cp_avg)&#39;</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                   <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span>
                   <span class="s1">&#39;double working_temp = 0&#39;</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                   <span class="p">)</span>

    <span class="c1"># need to finish the dYk/dYj&#39;s</span>
    <span class="n">write_dy_y_finish_comment</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
    <span class="n">unroll_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">CParams</span><span class="o">.</span><span class="n">Jacob_Spec_Unroll</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span>
                  <span class="k">else</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">Jacob_Spec_Unroll</span><span class="p">)</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">CParams</span><span class="o">.</span><span class="n">Max_Spec_Lines</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span>
                  <span class="k">else</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">Max_Spec_Lines</span><span class="p">)</span>

    <span class="n">touched_copy</span> <span class="o">=</span> <span class="n">touched</span><span class="p">[:]</span>
    <span class="n">J_nplusjplus_touched_copy</span> <span class="o">=</span> <span class="n">J_nplusjplus_touched</span><span class="p">[:]</span>
    <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="n">touched</span> <span class="o">=</span> <span class="n">touched_copy</span><span class="p">[:]</span>
        <span class="n">J_nplusjplus</span> <span class="o">=</span> <span class="n">J_nplusjplus_touched_copy</span><span class="p">[:]</span>
        <span class="n">next_fn_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k_sp</span><span class="p">,</span> <span class="n">sp_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">do_unroll</span> <span class="ow">and</span> <span class="n">k_sp</span> <span class="o">==</span> <span class="n">next_fn_index</span><span class="p">:</span>
                <span class="n">store_file</span> <span class="o">=</span> <span class="nb">file</span>
                <span class="n">next_fn_index</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">unroll_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="n">k_sp</span><span class="p">)</span>

                <span class="n">have_jnplus_jplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_fn_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
                                     <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">J_nplusjplus_touched</span><span class="p">)</span>
                                     <span class="p">)</span>

                <span class="nb">file</span> <span class="o">=</span> <span class="n">write_dy_intros</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacobs&#39;</span><span class="p">),</span>
                                       <span class="n">lang</span><span class="p">,</span> <span class="n">jac_count</span><span class="p">,</span> <span class="n">have_jnplus_jplus</span>
                                       <span class="p">)</span>

            <span class="k">for</span> <span class="n">j_sp</span><span class="p">,</span> <span class="n">sp_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
                <span class="n">lin_index</span> <span class="o">=</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">j_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1">#the num_s + 1 row is zero</span>
                <span class="c1">#so skip</span>
                <span class="k">if</span> <span class="n">j_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">num_s</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num_s</span> <span class="ow">and</span> <span class="n">touched</span><span class="p">[</span><span class="n">lin_index</span><span class="p">]:</span>
                    <span class="c1">#still in the actual jacobian</span>
                    <span class="c1">#and this combo matters</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
                    <span class="c1"># need to finish</span>
                    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">lin_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; += &#39;</span>
                    <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">j_sp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                 <span class="s1">&#39; = &#39;</span> <span class="o">+</span>
                                 <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">j_sp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                 <span class="s1">&#39; + &#39;</span>
                                 <span class="p">)</span>

                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39; * mw_avg * &#39;</span>
                             <span class="s1">&#39;{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">sp_k</span><span class="o">.</span><span class="n">mw</span> <span class="o">/</span> <span class="n">sp_j</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">*</span>
                                              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">sp_j</span><span class="o">.</span><span class="n">mw</span> <span class="o">/</span> <span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                                              <span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39; * rho_inv)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                             <span class="p">)</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">num_s</span> <span class="ow">and</span> <span class="n">J_nplusjplus_touched</span><span class="p">[</span><span class="n">j_sp</span><span class="p">]:</span>
                    <span class="c1">#out of bounds in the Jnplusjplus ones</span>
                    <span class="c1">#and this combo matters</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
                    <span class="c1"># need to finish</span>
                    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;J_nplusjplus&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; += &#39;</span>
                    <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;J_nplusjplus&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span> <span class="o">+</span>
                                 <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span><span class="p">)</span>

                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39; * mw_avg * &#39;</span>
                             <span class="s1">&#39;{:.16e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">sp_k</span><span class="o">.</span><span class="n">mw</span> <span class="o">/</span> <span class="n">sp_j</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">*</span>
                                              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">sp_j</span><span class="o">.</span><span class="n">mw</span> <span class="o">/</span> <span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                                              <span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39; * rho_inv)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                             <span class="p">)</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


                <span class="c1">######################################</span>
                <span class="c1"># Derivative with respect to species</span>
                <span class="c1">######################################</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span>
                <span class="n">my_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">j_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">my_index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">j_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">twod</span><span class="o">=</span><span class="n">j_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                     <span class="o">+</span> <span class="s1">&#39; +&#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">my_index</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                                     <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; -(&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {}= {}(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">my_index</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">my_index</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
                                              <span class="p">)</span>
                <span class="n">touched</span><span class="p">[</span><span class="n">my_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>


                <span class="n">jac_part</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num_s</span><span class="p">:</span>
                    <span class="c1">#still in the actual jacobian</span>
                    <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">lin_index</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                            <span class="n">jac_part</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;working_temp * &#39;</span> <span class="o">+</span>
                                        <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">lin_index</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s1">&#39; - &#39;</span>
                                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                            <span class="n">jac_part</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;working_temp * &#39;</span> <span class="o">+</span>
                                        <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">,</span> <span class="n">k_sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">twod</span><span class="o">=</span><span class="n">j_sp</span> <span class="o">+</span> <span class="mi">1</span>
                                                  <span class="p">)</span> <span class="o">+</span>
                                        <span class="s1">&#39; - &#39;</span>
                                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">jac_part</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#out of bounds, so need to check the</span>
                    <span class="c1">#Jnplusjplus ones</span>
                    <span class="k">if</span> <span class="n">J_nplusjplus_touched</span><span class="p">[</span><span class="n">j_sp</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                            <span class="n">jac_part</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;working_temp * &#39;</span> <span class="o">+</span>
                                        <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;J_nplusjplus&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s1">&#39; - &#39;</span>
                                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                            <span class="n">jac_part</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;working_temp * &#39;</span> <span class="o">+</span>
                                        <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;J_nplusjplus&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s1">&#39; - &#39;</span>
                                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">jac_part</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>

                <span class="n">sp_part</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;(j_temp * (&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">j_sp</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">num_s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                            <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s1">&#39; * {:.8e}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_k</span><span class="o">.</span><span class="n">mw</span><span class="p">))</span>

                <span class="n">line</span> <span class="o">+=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * (&#39;</span> <span class="o">+</span> <span class="n">jac_part</span> <span class="o">+</span> <span class="n">sp_part</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">jac_part</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span> <span class="ow">or</span> <span class="n">seen_sp</span><span class="p">[</span><span class="n">k_sp</span><span class="p">]:</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">do_unroll</span> <span class="ow">and</span> <span class="n">k_sp</span> <span class="o">==</span> <span class="n">next_fn_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># switch back</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="n">file_store</span>
                <span class="c1">#check that file length is under limit</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacobs&#39;</span><span class="p">,</span> <span class="s1">&#39;jacob_{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jac_count</span><span class="p">,</span>
                            <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])))</span> <span class="k">as</span> <span class="n">readfile</span><span class="p">:</span>
                    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">readfile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">num_lines</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
                    <span class="n">unroll_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unroll_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_jacob_{}(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jac_count</span><span class="p">))</span>
                <span class="n">jac_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;mw_avg, rho, cp_avg, spec_rates, h, cp, jac&#39;</span>
                <span class="k">if</span> <span class="n">have_jnplus_jplus</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, J_nplusjplus&#39;</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">k_sp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1">######################################</span>
    <span class="c1"># Derivatives with respect to temperature</span>
    <span class="c1">######################################</span>
    <span class="n">write_dcp_dt</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">)</span>

    <span class="c1">######################################</span>
    <span class="c1"># Derivative with respect to species</span>
    <span class="c1">######################################</span>
    <span class="c1"># write_dt_y_comment(file, lang, sp)</span>
    <span class="c1"># write_dt_y(file, lang, specs, sp, isp, num_s, touched,</span>
    <span class="c1">#            sparse_indicies, get_array</span>
    <span class="c1">#            )</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># next need to divide everything out</span>
    <span class="c1">#write_dt_y_division(file, lang, specs, num_s, get_array)</span>

    <span class="c1"># finish the dT entry</span>
    <span class="n">write_dt_completion</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">J_nplusone_touched</span><span class="p">,</span> <span class="n">get_array</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_jacob</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_jacob</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># create include file</span>
    <span class="k">if</span> <span class="n">do_unroll</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacobs&#39;</span><span class="p">,</span> <span class="s1">&#39;jac_include&#39;</span> <span class="o">+</span>
                  <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span>
                  <span class="p">)</span> <span class="k">as</span> <span class="n">tempfile</span><span class="p">:</span>
            <span class="n">tempfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef JAC_INCLUDE_H</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;#define JAC_INCLUDE_H</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jac_count</span><span class="p">):</span>
                <span class="n">tempfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;jacob_{}{}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
                               <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                               <span class="p">)</span>
            <span class="n">tempfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#endif</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;jacobs&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;jac_list_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lang</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span>
                  <span class="p">)</span> <span class="k">as</span> <span class="n">tempfile</span><span class="p">:</span> \
            <span class="n">tempfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;jacob_{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
                           <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jac_count</span><span class="p">)])</span>
                           <span class="p">)</span>
    <span class="k">return</span> <span class="n">touched</span></div>


<div class="viewcode-block" id="write_sparse_multiplier"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.write_sparse_multiplier">[docs]</a><span class="k">def</span> <span class="nf">write_sparse_multiplier</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">touched</span><span class="p">,</span> <span class="n">nvars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a subroutine that multiplies the non-zero entries of the</span>
<span class="sd">    Jacobian with a column &#39;j&#39; of another matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Programming language.</span>
<span class="sd">    inidicies : list</span>
<span class="sd">        A list of indicies where the Jacobian is non-zero</span>
<span class="sd">    nvars : int</span>
<span class="sd">        Number of variables in the Jacobian matrix</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sparse_indicies</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span> <span class="o">*</span> <span class="n">nvars</span><span class="p">)</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">nvars</span><span class="p">]]</span>

    <span class="c1"># first write header file</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                <span class="s1">&#39;sparse_multiplier{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])),</span> <span class="s1">&#39;w&#39;</span>
                <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef SPARSE_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#define SPARSE_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#define N_A {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_indicies</span><span class="p">)))</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;#include &quot;header{}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
        <span class="p">(</span><span class="s1">&#39;__device__</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="s1">&#39;void sparse_multiplier (const double *, const double *, double*);</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;#ifdef COMPILE_TESTING_METHODS</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  int test_sparse_multiplier();</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># create file depending on language</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;sparse_multiplier&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;sparse_multiplier&#39;</span>
               <span class="s1">&#39;{}&quot;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
               <span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;__device__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;void sparse_multiplier(const double * A, &#39;</span>
               <span class="s1">&#39;const double * Vm, double* w) {</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;optimize for cache reusing&quot;&quot;&quot;</span>
        <span class="n">touched</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">):</span>
            <span class="c1"># get all indicies that belong to row i</span>
            <span class="n">i_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sparse_indicies</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">nvars</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">i_list</span><span class="p">:</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span>
                           <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">%</span> <span class="n">nvars</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s1">&#39; {}= &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">touched</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="n">nvars</span><span class="p">]</span>
                           <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                           <span class="p">)</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;Vm&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                           <span class="p">)</span>
                <span class="n">touched</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="n">nvars</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">zero_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">touched</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">zero_out</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = 0&#39;</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">):</span>
            <span class="c1"># get all indicies that belong to row i</span>
            <span class="n">i_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sparse_indicies</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="n">nvars</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_list</span><span class="p">):</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span>
                           <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = 0&#39;</span> <span class="o">+</span>
                           <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                           <span class="p">)</span>
                <span class="k">continue</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">i_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">)</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span>
                           <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;Vm&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span> <span class="o">/</span> <span class="n">nvars</span><span class="p">)))</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_jacobian"><a class="viewcode-back" href="../../../src/pyjac.core.create_jacobian.html#pyjac.core.create_jacobian.create_jacobian">[docs]</a><span class="k">def</span> <span class="nf">create_jacobian</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">mech_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">therm_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gas</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">optimize_cache</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">initial_state</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">num_blocks</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                    <span class="n">no_shared</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">L1_preferred</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">multi_thread</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">force_optimize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">build_path</span><span class="o">=</span><span class="s1">&#39;./out/&#39;</span><span class="p">,</span> <span class="n">last_spec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">skip_jac</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_diff</span><span class="o">=</span><span class="bp">False</span>
                    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create Jacobian subroutine from mechanism.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lang : {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Language type.</span>
<span class="sd">    mech_name : str, optional</span>
<span class="sd">        Reaction mechanism filename (e.g. &#39;mech.dat&#39;).</span>
<span class="sd">        This or gas must be specified</span>
<span class="sd">    therm_name : str, optional</span>
<span class="sd">        Thermodynamic database filename (e.g. &#39;therm.dat&#39;)</span>
<span class="sd">        or nothing if info in mechanism file.</span>
<span class="sd">    gas : cantera.Solution, optional</span>
<span class="sd">        The mechanism to generate the Jacobian for.  This or mech_name must be specified</span>
<span class="sd">    optimize_cache : bool, optional</span>
<span class="sd">        If true, use the greedy optimizer to attempt to</span>
<span class="sd">        improve cache hit rates</span>
<span class="sd">    initial_state : str, optional</span>
<span class="sd">        A comma separated list of the initial conditions to use in form</span>
<span class="sd">        T,P,X (e.g. &#39;800,1,H2=1.0,O2=0.5&#39;). Temperature in K, P in atm</span>
<span class="sd">    num_blocks : int, optional</span>
<span class="sd">        The target number of blocks / sm to achieve for cuda</span>
<span class="sd">    num_threads : int, optional</span>
<span class="sd">        The target number of threads / block to achieve for cuda</span>
<span class="sd">    no_shared : bool, optional</span>
<span class="sd">        If ``True``, do not use the shared_memory_manager</span>
<span class="sd">        to attempt to optimize for CUDA</span>
<span class="sd">    L1_preferred : bool, optional</span>
<span class="sd">        If ``True``, prefer a larger L1 cache</span>
<span class="sd">        and a smaller shared memory size for CUDA</span>
<span class="sd">    multi_thread : int, optional</span>
<span class="sd">        The number of threads to use during optimization</span>
<span class="sd">    force_optimize : bool, optional</span>
<span class="sd">        If ``True``, redo the cache optimization even if the same mechanism</span>
<span class="sd">    build_path : str, optional</span>
<span class="sd">        The output directory for the jacobian files</span>
<span class="sd">    last_spec : str, optional</span>
<span class="sd">        If specified, the species to assign to the last index.</span>
<span class="sd">        Typically should be N2, Ar, He or another inert bath gas</span>
<span class="sd">    skip_jac : bool, optional</span>
<span class="sd">        If ``True``, only the reaction rate subroutines will be generated</span>
<span class="sd">    auto_diff : bool, optional</span>
<span class="sd">        If ``True``, generate files for use with the Adept autodifferention library.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;c&#39;</span> <span class="ow">and</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Error: autodifferention only supported for C&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">skip_jac</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">langs</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Error: language needs to be one of: &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">langs</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># create output directory if none exists</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">build_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="s1">&#39;ad_jacob.h&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef AD_JAC_H</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;#define AD_JAC_H</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;void eval_jacob (const double t, const double pres, const double* y, double* jac);</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">mech_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">gas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;No mechanism specified!&quot;</span>

    <span class="c1"># Interpret reaction mechanism file, depending on Cantera or</span>
    <span class="c1"># Chemkin format.</span>
    <span class="k">if</span> <span class="n">gas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">mech_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="s1">&#39;.cti&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">])):</span>
        <span class="n">elems</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span> <span class="o">=</span> <span class="n">mech</span><span class="o">.</span><span class="n">read_mech_ct</span><span class="p">(</span><span class="n">mech_name</span><span class="p">,</span> <span class="n">gas</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">elems</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span> <span class="o">=</span> <span class="n">mech</span><span class="o">.</span><span class="n">read_mech</span><span class="p">(</span><span class="n">mech_name</span><span class="p">,</span> <span class="n">therm_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">specs</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No species found in file: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mech_name</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">reacs</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No reactions found in file: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mech_name</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1">#check to see if the last_spec is specified</span>
    <span class="k">if</span> <span class="n">last_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1">#find the index if possible</span>
        <span class="n">isp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">last_spec</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                   <span class="bp">None</span>
                   <span class="p">)</span>
        <span class="k">if</span> <span class="n">isp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning: User specified last species {} &#39;</span>
                  <span class="s1">&#39;not found in mechanism.&#39;</span>
                  <span class="s1">&#39;  Attempting to find a default species.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_spec</span><span class="p">)</span>
                  <span class="p">)</span>
            <span class="n">last_spec</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_spec</span> <span class="o">=</span> <span class="n">isp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;User specified last species not found or not specified.  &#39;</span>
              <span class="s1">&#39;Attempting to find a default species&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">last_spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">wt</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">get_elem_wt</span><span class="p">()</span>
        <span class="c1">#check for N2, Ar, He, etc.</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;N2&#39;</span><span class="p">,</span> <span class="n">wt</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Ar&#39;</span><span class="p">,</span> <span class="n">wt</span><span class="p">[</span><span class="s1">&#39;ar&#39;</span><span class="p">]),</span>
                        <span class="p">(</span><span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="n">wt</span><span class="p">[</span><span class="s1">&#39;he&#39;</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">isp</span> <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span>
                          <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">spec</span><span class="o">.</span><span class="n">mw</span><span class="p">),</span>
                            <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">last_spec</span> <span class="o">=</span> <span class="n">match</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">last_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Default last species &#39;</span>
                  <span class="s1">&#39;{} found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">last_spec</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                  <span class="p">)</span>
    <span class="k">if</span> <span class="n">last_spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning: Neither a user specified or default last species &#39;</span>
              <span class="s1">&#39;could be found. Proceeding using the last species in the &#39;</span>
              <span class="s1">&#39;base mechanism: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">last_spec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">optimize_cache</span> <span class="o">=</span> <span class="n">optimize_cache</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">have_bitarray</span>
    <span class="k">if</span> <span class="n">optimize_cache</span><span class="p">:</span>
        <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> \
        <span class="n">fwd_spec_mapping</span><span class="p">,</span> <span class="n">fwd_rxn_mapping</span><span class="p">,</span> \
        <span class="n">reverse_spec_mapping</span><span class="p">,</span> <span class="n">reverse_rxn_mapping</span> <span class="o">=</span> \
                <span class="n">cache</span><span class="o">.</span><span class="n">optimize_cache</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">multi_thread</span><span class="p">,</span>
                                     <span class="n">force_optimize</span><span class="p">,</span> <span class="n">build_path</span><span class="p">,</span> <span class="n">last_spec</span>
                                     <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fwd_rxn_mapping</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">))</span>
        <span class="n">reverse_rxn_mapping</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">))</span>

        <span class="n">fwd_spec_mapping</span><span class="p">,</span> \
        <span class="n">reverse_spec_mapping</span> <span class="o">=</span> \
            <span class="n">utils</span><span class="o">.</span><span class="n">get_species_mappings</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span> <span class="n">last_spec</span><span class="p">)</span>

        <span class="c1">#pick up the last_spec and drop it at the end</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)):</span>
            <span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">fwd_spec_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>


    <span class="c1">#remove old file which potentially could corrupt library generation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="s1">&#39;jacobs&#39;</span><span class="p">,</span> <span class="s1">&#39;jac_list_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lang</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="s1">&#39;rates&#39;</span><span class="p">,</span> <span class="s1">&#39;rate_list_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lang</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>


    <span class="n">the_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">CUDAParams</span><span class="o">.</span><span class="n">write_launch_bounds</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span>
                                       <span class="n">L1_preferred</span><span class="p">,</span> <span class="n">no_shared</span>
                                       <span class="p">)</span>
    <span class="n">smm</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_shared</span><span class="p">:</span>
        <span class="n">smm</span> <span class="o">=</span> <span class="n">shared</span><span class="o">.</span><span class="n">shared_memory_manager</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span>
                                           <span class="n">L1_preferred</span>
                                           <span class="p">)</span>

    <span class="c1">#reassign the reaction&#39;s product / reactant / third body list</span>
    <span class="c1"># to integer indexes for speed</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">reassign_species_lists</span><span class="p">(</span><span class="n">reacs</span><span class="p">,</span> <span class="n">specs</span><span class="p">)</span>

    <span class="c1">## now begin writing subroutines</span>

    <span class="c1"># print reaction rate subroutine</span>
    <span class="n">rate</span><span class="o">.</span><span class="n">write_rxn_rates</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span>
                         <span class="n">fwd_rxn_mapping</span><span class="p">,</span> <span class="n">smm</span><span class="p">,</span> <span class="n">auto_diff</span>
                         <span class="p">)</span>

    <span class="c1"># if third-body/pressure-dependent reactions,</span>
    <span class="c1"># print modification subroutine</span>
    <span class="k">if</span> <span class="nb">next</span><span class="p">((</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reacs</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">thd_body</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">pdep</span><span class="p">)),</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">rate</span><span class="o">.</span><span class="n">write_rxn_pressure_mod</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span>
                                    <span class="n">fwd_rxn_mapping</span><span class="p">,</span> <span class="n">smm</span><span class="p">,</span> <span class="n">auto_diff</span>
                                    <span class="p">)</span>

    <span class="c1"># write species rates subroutine</span>
    <span class="n">seen_sp</span> <span class="o">=</span> <span class="n">rate</span><span class="o">.</span><span class="n">write_spec_rates</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span>
                    <span class="n">fwd_spec_mapping</span><span class="p">,</span> <span class="n">fwd_rxn_mapping</span><span class="p">,</span> <span class="n">smm</span><span class="p">,</span> <span class="n">auto_diff</span><span class="p">)</span>

    <span class="c1"># write chem_utils subroutines</span>
    <span class="n">rate</span><span class="o">.</span><span class="n">write_chem_utils</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">auto_diff</span><span class="p">)</span>

    <span class="c1"># write derivative subroutines</span>
    <span class="n">rate</span><span class="o">.</span><span class="n">write_derivs</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">seen_sp</span><span class="p">,</span> <span class="n">auto_diff</span><span class="p">)</span>

    <span class="c1"># write mass-mole fraction conversion subroutine</span>
    <span class="n">rate</span><span class="o">.</span><span class="n">write_mass_mole</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">)</span>

    <span class="c1"># write header file</span>
    <span class="n">aux</span><span class="o">.</span><span class="n">write_header</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>

    <span class="c1"># write mechanism initializers and testing methods</span>
    <span class="n">aux</span><span class="o">.</span><span class="n">write_mechanism_initializers</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span>
                                     <span class="n">initial_state</span><span class="p">,</span> <span class="n">reverse_spec_mapping</span><span class="p">,</span>
                                     <span class="n">reverse_rxn_mapping</span><span class="p">,</span> <span class="n">optimize_cache</span><span class="p">,</span>
                                     <span class="n">last_spec</span><span class="p">,</span> <span class="n">auto_diff</span>
                                     <span class="p">)</span>

    <span class="k">if</span> <span class="n">skip_jac</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="c1"># write Jacobian subroutine</span>
        <span class="n">touched</span> <span class="o">=</span> <span class="n">write_jacobian</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span>
                                         <span class="n">reacs</span><span class="p">,</span> <span class="n">seen_sp</span><span class="p">,</span> <span class="n">smm</span><span class="p">)</span>

        <span class="n">write_sparse_multiplier</span><span class="p">(</span><span class="n">build_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">touched</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span>

    <span class="k">return</span> <span class="mi">0</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parser</span><span class="p">()</span>

    <span class="n">create_jacobian</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span>
                    <span class="n">mech_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                    <span class="n">therm_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">thermo</span><span class="p">,</span>
                    <span class="n">optimize_cache</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_optimizer</span><span class="p">,</span>
                    <span class="n">initial_state</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">initial_conditions</span><span class="p">,</span>
                    <span class="n">num_blocks</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">,</span>
                    <span class="n">num_threads</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_threads</span><span class="p">,</span>
                    <span class="n">no_shared</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">no_shared</span><span class="p">,</span>
                    <span class="n">L1_preferred</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">L1_preferred</span><span class="p">,</span>
                    <span class="n">multi_thread</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">multi_thread</span><span class="p">,</span>
                    <span class="n">force_optimize</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force_optimize</span><span class="p">,</span>
                    <span class="n">build_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span>
                    <span class="n">last_spec</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">last_species</span><span class="p">,</span>
                    <span class="n">auto_diff</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">auto_diff</span>
                    <span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">pyJac</a></h1>



<p class="blurb">Python-based generator of analytical Jacobians for chemical kinetics</p>



<p>
<iframe src="https://ghbtns.com/github-btn.html?user=kyleniemeyer&repo=pyjac&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>




<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/index.html">pyJac API</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Kyle Niemeyer, Nicholas Curtis.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    
    <a href="https://github.com/kyleniemeyer/pyjac" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>