<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyjac.core.rate_subs &#8212; pyJac 1.0.3 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="top" title="pyJac 1.0.3 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyjac.core.rate_subs</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Module for writing species/reaction rate subroutines.</span>

<span class="sd">This is kept separate from Jacobian creation module in order</span>
<span class="sd">to create only the rate subroutines if desired.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Python 2 compatibility</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="c1"># Standard libraries</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Local imports</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">chem_utilities</span> <span class="k">as</span> <span class="n">chem</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">mech_interpret</span> <span class="k">as</span> <span class="n">mech</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">CUDAParams</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">cache_optimizer</span> <span class="k">as</span> <span class="n">cache</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">mech_auxiliary</span> <span class="k">as</span> <span class="n">aux</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">shared_memory</span> <span class="k">as</span> <span class="n">shared</span>


<div class="viewcode-block" id="rxn_rate_const"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.rate_subs.rxn_rate_const">[docs]</a><span class="k">def</span> <span class="nf">rxn_rate_const</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;Returns line with reaction rate calculation (after = sign).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : float</span>
<span class="sd">        Arrhenius pre-exponential coefficient</span>
<span class="sd">    b : float</span>
<span class="sd">        Arrhenius temperature exponent</span>
<span class="sd">    E : float</span>
<span class="sd">        Arrhenius activation energy</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    line : str</span>
<span class="sd">        String with expression for reaction rate.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Form of the reaction rate constant (from, e.g., Lu and Law [1]_):</span>

<span class="sd">    .. math::</span>
<span class="sd">        :nowrap:</span>

<span class="sd">        k_f = \begin{cases}</span>
<span class="sd">        A &amp; \text{if } \beta = 0 \text{ and } T_a = 0 \\</span>
<span class="sd">        \exp \left( \log A + \beta \log T \right) &amp;</span>
<span class="sd">        \text{if } \beta \neq 0 \text{ and } \text{if } T_a = 0 \\</span>
<span class="sd">        \exp \left( \log A + \beta \log T - T_a / T \right)	&amp;</span>
<span class="sd">        \text{if } \beta \neq 0 \text{ and } T_a \neq 0 \\</span>
<span class="sd">        \exp \left( \log A - T_a / T \right)</span>
<span class="sd">        &amp; \text{if } \beta = 0 \text{ and } T_a \neq 0 \\</span>
<span class="sd">        A \prod^b T	&amp; \text{if } T_a = 0 \text{ and }</span>
<span class="sd">        b \in \mathbb{Z} \text{ (integers) }</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    .. [1] TF Lu and CK Law, &quot;Toward accommodating realistic fuel chemistry</span>
<span class="sd">       in large-scale computations,&quot; Progress in Energy and Combustion</span>
<span class="sd">       Science, vol. 35, pp. 192-215, 2009. doi:10.1016/j.pecs.2008.10.002</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">A</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logA</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">E</span><span class="p">:</span>
            <span class="c1"># E = 0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
                <span class="c1"># b = 0</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># b != 0</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * T&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(</span><span class="si">{:.16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logA</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * logT)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># E != 0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
                <span class="c1"># b = 0</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(</span><span class="si">{:.16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logA</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - (</span><span class="si">{:.16e}</span><span class="s1"> / T))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># b!= 0</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(</span><span class="si">{:.16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logA</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * logT - (</span><span class="si">{:.16e}</span><span class="s1"> / T))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">A</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">#a &lt; 0, can&#39;t take the log of it</span>
        <span class="c1">#the reaction, should also be a duplicate to make any sort of sense</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">E</span><span class="p">:</span>
            <span class="c1">#E = 0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
                <span class="c1">#b = 0</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#b != 0</span>
                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * T&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * exp(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * logT)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#E != 0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
                <span class="c1"># b = 0</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * exp(-(</span><span class="si">{:.16e}</span><span class="s1"> / T))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># b!= 0</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * exp(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * logT - (</span><span class="si">{:.16e}</span><span class="s1"> / T))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">return</span> <span class="n">line</span></div>


<div class="viewcode-block" id="get_cheb_rate"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.rate_subs.get_cheb_rate">[docs]</a><span class="k">def</span> <span class="nf">get_cheb_rate</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">write_defns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a reaction, and a temperature and pressure, this routine</span>
<span class="sd">    will generate code to evaluate the Chebyshev rate efficiently.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Assumes existence of variables dot_prod* of sized at least rxn.cheb_n_temp</span>
<span class="sd">    Pred and Tred, T and pres, and kf, cheb_temp_0 and cheb_temp_1.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lang : str</span>
<span class="sd">        Programming language</span>
<span class="sd">    rxn : `ReacInfo`</span>
<span class="sd">        Reaction with Chebyshev pressure dependence.</span>
<span class="sd">    write_defns : bool, optional</span>
<span class="sd">        If ``True`` (default), write calculation of ``Tred`` and ``Pred``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    line : list of `str`</span>
<span class="sd">        Line with evaluation of Chebyshev reaction rate.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">line_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tlim_inv_sum</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tlim_inv_sub</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">write_defns</span><span class="p">:</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;Tred = ((2.0 / T) - &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;</span><span class="si">{:.8e}</span><span class="s1">) / </span><span class="si">{:.8e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tlim_inv_sum</span><span class="p">,</span> <span class="n">tlim_inv_sub</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="n">plim_log_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>
    <span class="n">plim_log_sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
    <span class="k">if</span> <span class="n">write_defns</span><span class="p">:</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;Pred = (2.0 * log10(pres) - &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;</span><span class="si">{:.8e}</span><span class="s1">) / </span><span class="si">{:.8e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plim_log_sum</span><span class="p">,</span> <span class="n">plim_log_sub</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cheb_temp_0 = 1&#39;</span><span class="p">)</span>
    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cheb_temp_1 = Pred&#39;</span><span class="p">)</span>
    <span class="c1">#start pressure dot product</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span><span class="p">):</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span>
          <span class="s1">&#39;= </span><span class="si">{:.8e}</span><span class="s1"> + Pred * </span><span class="si">{:.8e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_par</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_par</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

    <span class="c1">#finish pressure dot product</span>
    <span class="n">update_one</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_pres</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">update_one</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;cheb_temp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = 2 * Pred * cheb_temp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - cheb_temp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span><span class="p">):</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="o">+</span>
              <span class="s1">&#39; += </span><span class="si">{:.8e}</span><span class="s1"> * cheb_temp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_par</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">old</span><span class="p">))</span>

        <span class="n">update_one</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">update_one</span>

    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cheb_temp_0 = 1&#39;</span><span class="p">)</span>
    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cheb_temp_1 = Tred&#39;</span><span class="p">)</span>
    <span class="c1">#finally, do the temperature portion</span>
    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;kf = &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39; + Tred * &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">update_one</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">update_one</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;cheb_temp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = 2 * Tred * cheb_temp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - cheb_temp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;kf += &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dot_prod&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="s1">&#39;cheb_temp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">))</span>

        <span class="n">update_one</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">update_one</span>

    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;kf = &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">exp_10_fun</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;kf)&#39;</span><span class="p">)</span>
    <span class="n">line_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="k">for</span>
                  <span class="n">line</span> <span class="ow">in</span> <span class="n">line_list</span><span class="p">]</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_rxn_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.rate_subs.write_rxn_rates">[docs]</a><span class="k">def</span> <span class="nf">write_rxn_rates</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">fwd_rxn_mapping</span><span class="p">,</span>
                    <span class="n">smm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write reaction rate subroutine.</span>

<span class="sd">    Includes conditionals for reversible reactions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Programming language.</span>
<span class="sd">    specs : list of `SpecInfo`</span>
<span class="sd">        List of species in the mechanism.</span>
<span class="sd">    reacs : list of `ReacInfo`</span>
<span class="sd">        List of reactions in the mechanism.</span>
<span class="sd">    fwd_rxn_mapping : List of integers</span>
<span class="sd">        The index of the reaction in the original mechanism</span>
<span class="sd">    smm : `shared_memory_manager`, optional</span>
<span class="sd">        If not ``None`` (default), `shared_memory_manager` for CUDA optimizations</span>
<span class="sd">    auto_diff : Optional[bool]</span>
<span class="sd">        If ``True``, generate files for Adept autodifferention library.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_s</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
    <span class="n">num_r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span>
    <span class="n">rev_reacs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">]</span>
    <span class="n">num_rev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_reacs</span><span class="p">)</span>
    <span class="n">pdep_reacs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span><span class="p">]</span>

    <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;__device__ &#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;ad_&#39;</span> <span class="k">if</span> <span class="n">auto_diff</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">pres_ref</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span> <span class="k">if</span> <span class="n">auto_diff</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">)</span>
                                <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef RATES_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#define RATES_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#include &quot;header</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;gpu_memory.cuh&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;double&#39;</span>
    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;adouble&#39;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;adept.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;using adept::adouble;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">cuda_cheb</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_rxn_rates (const </span><span class="si">{1}</span><span class="s1">,&#39;</span>
               <span class="s1">&#39; const </span><span class="si">{1}{2}</span><span class="s1">, const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">&#39;</span>
               <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">cuda_cheb</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;);</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_spec_rates (const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">,&#39;</span>
               <span class="s1">&#39; const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">pdep_reacs</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void get_rxn_pres_mod (const </span><span class="si">{1}</span><span class="s1">, const &#39;</span>
                   <span class="s1">&#39;</span><span class="si">{1}{2}</span><span class="s1">, const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                   <span class="n">pre</span><span class="p">,</span> <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">file_prefix</span> <span class="o">+</span> <span class="s1">&#39;rxn_rates&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">do_unroll</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">Rates_Unroll</span><span class="p">:</span>
        <span class="c1"># make paths for separate rate files</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rates&#39;</span><span class="p">))</span>
        <span class="n">rate_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">do_unroll</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">next_file</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">get_array</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">get_array</span> <span class="o">=</span> <span class="n">smm</span><span class="o">.</span><span class="n">get_array</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_unroll</span><span class="p">:</span>
            <span class="n">smm</span><span class="o">.</span><span class="n">write_init</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_header</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rate_count</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes reaction rate header file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lang : str</span>
<span class="sd">            Programming language</span>
<span class="sd">        rate_count : int</span>
<span class="sd">            Number of reaction rate files.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rates&#39;</span><span class="p">,</span> <span class="s1">&#39;rxn_rates_</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">rate_count</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;#ifndef RATES_HEAD_</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;#define RATES_HEAD_</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;#include &quot;header</span><span class="si">{1}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rate_count</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="k">else</span> <span class="s1">&#39;__device__ &#39;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_rxn_rates_</span><span class="si">{4}</span><span class="s1">(const </span><span class="si">{1}</span><span class="s1">,&#39;</span>
                   <span class="s1">&#39; const </span><span class="si">{1}{2}</span><span class="s1">, const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
            <span class="k">if</span> <span class="n">cuda_cheb</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span>  <span class="s1">&#39;, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">&#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;);</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pre</span><span class="p">,</span> <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span> <span class="n">rate_count</span><span class="p">))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_sub_intro</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">defines</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">rate_count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write introduction to reaction rate subroutine.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : file</span>
<span class="sd">            Open file for reaction rate subroutines</span>
<span class="sd">        defines : bool</span>
<span class="sd">            If ``True``, write variable definitions</span>
<span class="sd">        start : int</span>
<span class="sd">            Index of initial reaction for this subroutine</span>
<span class="sd">        end : int</span>
<span class="sd">            Index of final reaction for this subroutine</span>
<span class="sd">        rate_count : int, optional</span>
<span class="sd">            Number of reaction rate files.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span> <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;__device__ &#39;</span>

        <span class="n">my_reacs</span> <span class="o">=</span> <span class="n">reacs</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">defines</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;rates/rates_include</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;</span><span class="si">{}</span><span class="s1">rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">file_prefix</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;adept.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;using adept::adouble;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;void eval_rxn_rates</span><span class="si">{0}</span><span class="s1"> (const </span><span class="si">{1}</span><span class="s1"> T, const </span><span class="si">{1}{2}</span><span class="s1"> pres,&#39;</span>
                     <span class="s1">&#39; const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1"> C, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1"> fwd_rxn_rates, &#39;</span>
                     <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1"> rev_rxn_rates</span><span class="si">{4}</span><span class="s1">) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rate_count</span><span class="p">)</span> <span class="k">if</span> <span class="n">rate_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span>
                     <span class="s1">&#39;, </span><span class="si">{}</span><span class="s1"> * </span><span class="si">{}</span><span class="s1"> dot_prod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="k">if</span> <span class="n">cuda_cheb</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                     <span class="p">)</span>
                     <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;subroutine eval_rxn_rates(T, pres, C, fwd_rxn_rates,&#39;</span>
                     <span class="s1">&#39; rev_rxn_rates)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                     <span class="p">)</span>

            <span class="c1"># fortran needs type declarations</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;  double precision, intent(in) :: &#39;</span>
                     <span class="s1">&#39;T, pres, C(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span>
                     <span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  double precision, intent(out) :: &#39;</span>
                     <span class="s1">&#39;fwd_rxn_rates(</span><span class="si">{}</span><span class="s1">), &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_r</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39;rev_rxn_rates(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_rev</span><span class="p">)</span>
                     <span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  </span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;  double precision :: logT</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="p">)</span>

            <span class="n">kf_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">rev_reacs</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">rev_par</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">my_reacs</span><span class="p">]):</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  double precision :: kf, Kc</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">kf_flag</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">my_reacs</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">kf_flag</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  double precision :: kf, Tred, Pred</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">kf_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  double precision :: Tred, Pred</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">rxn</span><span class="o">.</span><span class="n">plog</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">my_reacs</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">kf_flag</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  double precision :: kf, kf2</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">kf_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  double precision :: kf2</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;function [fwd_rxn_rates, rev_rxn_rates] = &#39;</span>
                     <span class="s1">&#39;eval_rxn_rates (T, pres, C)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;  fwd_rxn_rates = zeros(</span><span class="si">{}</span><span class="s1">,1);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_r</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39;  rev_rxn_rates = fwd_rxn_rates;</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">smm</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">defines</span><span class="p">:</span>
                <span class="n">smm</span><span class="o">.</span><span class="n">write_init</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">defines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                <span class="n">pre</span> <span class="o">+=</span> <span class="n">double_type</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                <span class="n">pre</span> <span class="o">+=</span> <span class="s1">&#39;register </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;logT = log(T)&#39;</span> <span class="o">+</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">kf_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">rev_reacs</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">rev_par</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">my_reacs</span><span class="p">]):</span>
                <span class="n">kf_flag</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> kf;</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> Kc;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span>
                               <span class="p">)</span>
                <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  register double kf;</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;  register double Kc;</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="p">)</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">my_reacs</span><span class="p">]):</span>
                <span class="c1"># Other variables needed for Chebyshev</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kf_flag</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> kf;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
                        <span class="n">kf_flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> Tred;</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> Pred;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> cheb_temp_0, cheb_temp_1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">double_type</span><span class="p">)</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                               <span class="p">)</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb_n_temp</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">my_reacs</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> dot_prod[</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="o">+</span>
                               <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>


                <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kf_flag</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  register double kf;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">kf_flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  register double Tred;</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;  register double Pred;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double cheb_temp_0, cheb_temp_1&#39;</span> <span class="o">+</span>
                               <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                               <span class="p">)</span>


            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">rxn</span><span class="o">.</span><span class="n">plog</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">my_reacs</span><span class="p">]):</span>
                <span class="c1"># Variables needed for Plog</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kf_flag</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> kf;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> kf2;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kf_flag</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  register double kf;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  register double kf2;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">rrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">do_unroll</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">Rates_Unroll</span><span class="p">)</span>
    <span class="n">write_sub_intro</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="ow">not</span> <span class="n">do_unroll</span><span class="p">,</span> <span class="n">rrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rrange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__get_arrays</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># put together all our coeffs</span>
        <span class="n">lo_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">nu</span> <span class="o">*</span> <span class="n">factor</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="n">lo_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">lo_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lo_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="n">lo_array</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                    <span class="p">]</span>

        <span class="n">hi_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">nu</span> <span class="o">*</span> <span class="n">factor</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="n">hi_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">hi_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">hi_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="n">hi_array</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                    <span class="p">]</span>
        <span class="k">return</span> <span class="n">lo_array</span><span class="p">,</span> <span class="n">hi_array</span>

    <span class="k">for</span> <span class="n">i_rxn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">do_unroll</span> <span class="ow">and</span> <span class="n">i_rxn</span> <span class="o">==</span> <span class="n">next_file</span><span class="p">:</span>
            <span class="n">file_store</span> <span class="o">=</span> <span class="n">file</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rates&#39;</span><span class="p">,</span> <span class="s1">&#39;rxn_rates_</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rate_count</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">next_file</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">),</span> <span class="n">i_rxn</span> <span class="o">+</span> <span class="n">CUDAParams</span><span class="o">.</span><span class="n">Rates_Unroll</span><span class="p">)</span>
            <span class="n">write_sub_intro</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">i_rxn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">next_file</span><span class="p">,</span> <span class="n">rate_count</span><span class="p">)</span>
            <span class="n">rate_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
                    <span class="s1">&#39;rxn </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fwd_rxn_mapping</span><span class="p">[</span><span class="n">i_rxn</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">rxn</span> <span class="o">=</span> <span class="n">reacs</span><span class="p">[</span><span class="n">i_rxn</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">)))</span>
            <span class="n">the_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">shared</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]</span>
            <span class="c1"># estimate usages as the number of consequitive reactions</span>
            <span class="n">usages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sp_i</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">i_rxn</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="ow">and</span>
                       <span class="n">sp_i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">reacs</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span>
                                   <span class="n">reacs</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">)</span>
                       <span class="p">):</span>
                    <span class="n">temp</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">usages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span> <span class="o">-</span> <span class="n">i_rxn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">smm</span><span class="o">.</span><span class="n">load_into_shared</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">the_vars</span><span class="p">,</span> <span class="n">usages</span><span class="p">)</span>

        <span class="c1"># if reversible, save forward rate constant for use</span>
        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  kf = &#39;</span> <span class="o">+</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_cheb_rate</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rxn</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog</span><span class="p">:</span>
            <span class="c1"># Special forward rate evaluation for Plog reacions</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  if (pres &lt;= </span><span class="si">{:.4e}</span><span class="s1">) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf = &#39;</span> <span class="o">+</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">vals2</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  }} else if ((pres &gt; </span><span class="si">{:.4e}</span><span class="s1">) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                        <span class="s1">&#39;&amp;&amp; (pres &lt;= </span><span class="si">{:.4e}</span><span class="s1">)) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf = log(&#39;</span> <span class="o">+</span>
                        <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                        <span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf2 = log(&#39;</span> <span class="o">+</span>
                        <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">vals2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vals2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                        <span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

                <span class="n">pres_log_diff</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vals2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf = exp(kf + (kf2 - kf) * (log(pres) - &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1">) / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span>
                        <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pres_log_diff</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

            <span class="n">vals</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog_par</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }} else if (pres &gt; </span><span class="si">{:.4e}</span><span class="s1">) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;    kf = &#39;</span> <span class="o">+</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rxn_rates&#39;</span><span class="p">,</span> <span class="n">i_rxn</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span>

        <span class="c1"># reactants</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">):</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># check if stoichiometric coefficient is double or integer</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
                <span class="c1"># integer, so just use multiplication</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nu</span><span class="p">)):</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;pow(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s1">&#39;, </span><span class="si">{}</span><span class="s1">) *&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
                         <span class="p">)</span>

        <span class="c1"># Rate constant: print if not reversible, or reversible but</span>
        <span class="c1"># with explicit reverse parameters.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">plog</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;kf&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">:</span>

                <span class="c1"># line = &#39;  Kc = 0.0&#39; + utils.line_end[lang]</span>
                <span class="c1"># file.write(line)</span>

                <span class="c1"># sum of stoichiometric coefficients</span>
                <span class="n">sum_nu</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">coeffs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># go through product species</span>
                <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">prod_sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
                    <span class="c1"># check if species also in reactants</span>
                    <span class="k">if</span> <span class="n">prod_sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">:</span>
                        <span class="n">isp2</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">prod_sp</span><span class="p">)</span>
                        <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span> <span class="o">-</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">isp2</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>

                    <span class="c1"># Skip species with zero overall</span>
                    <span class="c1"># stoichiometric coefficient.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">sum_nu</span> <span class="o">+=</span> <span class="n">nu</span>

                    <span class="c1"># get species object</span>
                    <span class="n">sp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">prod_sp</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: species &#39;</span> <span class="o">+</span> <span class="n">prod_sp</span> <span class="o">+</span> <span class="s1">&#39; in reaction &#39;</span>
                              <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not found.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_rxn</span><span class="p">)</span>
                              <span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

                    <span class="n">lo_array</span><span class="p">,</span> <span class="n">hi_array</span> <span class="o">=</span> <span class="n">__get_arrays</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
                        <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lo_array</span><span class="p">,</span> <span class="n">hi_array</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">lo_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lo_array</span><span class="p">))</span>
                            <span class="p">],</span> <span class="p">[</span>
                            <span class="n">hi_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hi_array</span><span class="p">))</span>
                            <span class="p">]</span>

                <span class="c1"># now loop through reactants</span>
                <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">reac_sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">):</span>
                    <span class="c1"># Check if species also in products;</span>
                    <span class="c1"># if so, already considered).</span>
                    <span class="k">if</span> <span class="n">reac_sp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">:</span> <span class="k">continue</span>

                    <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>
                    <span class="n">sum_nu</span> <span class="o">-=</span> <span class="n">nu</span>

                    <span class="c1"># get species object</span>
                    <span class="n">sp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">reac_sp</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: species &#39;</span> <span class="o">+</span> <span class="n">reac_sp</span> <span class="o">+</span> <span class="s1">&#39; in reaction &#39;</span>
                              <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not found.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_rxn</span><span class="p">)</span>
                              <span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

                    <span class="n">lo_array</span><span class="p">,</span> <span class="n">hi_array</span> <span class="o">=</span> <span class="n">__get_arrays</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">factor</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
                        <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lo_array</span><span class="p">,</span> <span class="n">hi_array</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">lo_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
                            <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lo_array</span><span class="p">))</span>
                            <span class="p">],</span> <span class="p">[</span><span class="n">hi_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
                            <span class="n">coeffs</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hi_array</span><span class="p">))</span>
                            <span class="p">]</span>

                <span class="n">isFirst</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">T_mid</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
                    <span class="c1"># need temperature conditional for equilibrium constants</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  if (T &lt;= </span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_mid</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; then</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="n">lo_array</span><span class="p">,</span> <span class="n">hi_array</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">T_mid</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    Kc = &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    Kc += &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    Kc = Kc + &#39;</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;logT + T * (&#39;</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T))) - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lo_array</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">+</span>
                             <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                             <span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  } else {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  else</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    Kc = &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    Kc += &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    Kc = Kc + &#39;</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;logT + T * (&#39;</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T))) - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hi_array</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">+</span>
                             <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                             <span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end if</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">isFirst</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  Kc = &#39;</span>
                        <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">chem</span><span class="o">.</span><span class="n">PA</span> <span class="o">/</span> <span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span> <span class="o">**</span> <span class="n">sum_nu</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39; * exp(Kc)&#39;</span> <span class="o">+</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rxn_rates&#39;</span><span class="p">,</span>
                                    <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i_rxn</span><span class="p">)</span>
                                    <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span>

            <span class="c1"># reactants (products from forward reaction)</span>
            <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">:</span>
                <span class="n">nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">isp</span><span class="p">)]</span>

                <span class="c1"># check if stoichiometric coefficient is double or integer</span>
                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
                    <span class="c1"># integer, so just use multiplication</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nu</span><span class="p">)):</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;pow(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;, </span><span class="si">{}</span><span class="s1">) * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
                             <span class="p">)</span>

            <span class="c1"># rate constant</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">:</span>
                <span class="c1"># explicit reverse Arrhenius parameters</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">rxn</span><span class="o">.</span><span class="n">rev_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                       <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use equilibrium constant</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;kf / Kc&#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_unroll</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i_rxn</span> <span class="o">==</span> <span class="n">next_file</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">i_rxn</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">file_store</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_rxn_rates_</span><span class="si">{}</span><span class="s1">(T, pres, C, fwd_rxn_rates, rev_rxn_rates</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rate_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;, dot_prod&#39;</span> <span class="k">if</span> <span class="n">cuda_cheb</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>


    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_rxn_rates</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_rxn_rates</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_unroll</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rates&#39;</span><span class="p">,</span> <span class="s1">&#39;rates_include&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef RATES_INCLUDE_</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lang</span><span class="p">))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#define RATES_INCLUDE_</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lang</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rate_count</span><span class="p">):</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;rxn_rates_</span><span class="si">{}{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rate_count</span><span class="p">):</span>
            <span class="n">write_header</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rates&#39;</span><span class="p">,</span> <span class="s1">&#39;rate_list_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lang</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;rxn_rates_</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
               <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rate_count</span><span class="p">)])</span>
               <span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="write_rxn_pressure_mod"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.rate_subs.write_rxn_pressure_mod">[docs]</a><span class="k">def</span> <span class="nf">write_rxn_pressure_mod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span>
                           <span class="n">fwd_rxn_mapping</span><span class="p">,</span> <span class="n">smm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_diff</span><span class="o">=</span><span class="kc">False</span>
                           <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write subroutine to for reaction pressure dependence modifications.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Language type.</span>
<span class="sd">    specs : list of `SpecInfo`</span>
<span class="sd">        List of species in mechanism.</span>
<span class="sd">    reacs : list of `ReacInfo`</span>
<span class="sd">        List of reactions in mechanism.</span>
<span class="sd">    fwd_rxn_mapping : List of int</span>
<span class="sd">        The order of the reaction in the original mechanism</span>
<span class="sd">    smm : `shared_memory_manager`, optional</span>
<span class="sd">        If not ```None```, `shared_memory_manager` to use for CUDA optimizations</span>
<span class="sd">    auto_diff : bool, optional</span>
<span class="sd">        If ```True```, generate files for Adept autodifferention library.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;double&#39;</span>
    <span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">pres_ref</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;adouble&#39;</span>
        <span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;ad_&#39;</span>
        <span class="n">pres_ref</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">file_prefix</span> <span class="o">+</span> <span class="s1">&#39;rxn_rates_pres_mod&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="c1"># headers</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &lt;math.h&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;#include &quot;header</span><span class="si">{1}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;#include &quot;</span><span class="si">{0}</span><span class="s1">rates</span><span class="si">{1}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="p">)</span>

        <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;adept.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;using adept::adouble;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;#define fmax(a, b) (a.value() &gt; b ? a : adouble(b))</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># list of reactions with third-body or pressure-dependence</span>
    <span class="n">pdep_reacs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thd_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pdep_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">troe_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sri_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i_rxn</span><span class="p">,</span> <span class="n">reac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body</span><span class="p">:</span>
            <span class="c1"># add reaction index to list</span>
            <span class="n">thd_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pdep_reacs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_rxn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">reac</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
            <span class="c1"># add reaction index to list</span>
            <span class="n">pdep_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pdep_reacs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_rxn</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">troe</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">troe_flag</span><span class="p">:</span> <span class="n">troe_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">sri</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sri_flag</span><span class="p">:</span> <span class="n">sri_flag</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span> <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;__device__ &#39;</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;void get_rxn_pres_mod (const </span><span class="si">{0}</span><span class="s1"> T, const </span><span class="si">{0}{1}</span><span class="s1"> pres, &#39;</span>
                 <span class="s1">&#39;const </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> C, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> pres_mod) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                 <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;subroutine get_rxn_pres_mod ( T, pres, C, pres_mod )</span><span class="se">\n\n</span><span class="s1">&#39;</span>

        <span class="c1"># fortran needs type declarations</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  double precision, intent(in) :: T, pres, &#39;</span>
                 <span class="s1">&#39;C(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span> <span class="o">+</span>
                 <span class="s1">&#39;  double precision, intent(out) :: &#39;</span>
                 <span class="s1">&#39;pres_mod(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdep_reacs</span><span class="p">))</span> <span class="o">+</span>
                 <span class="s1">&#39;  </span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  double precision :: logT, m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;function pres_mod = get_rxn_pres_mod (T, pres, C)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  pres_mod = zeros(</span><span class="si">{}</span><span class="s1">,1);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdep_reacs</span><span class="p">))</span>
                 <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">get_array</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">get_array</span> <span class="o">=</span> <span class="n">smm</span><span class="o">.</span><span class="n">get_array</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">write_init</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># declarations for third-body variables</span>
    <span class="k">if</span> <span class="n">thd_flag</span> <span class="ow">or</span> <span class="n">pdep_flag</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // third body variable declaration</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> thd;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // third body variable declaration</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  register double thd;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! third body variable declaration</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  double precision :: thd</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>

    <span class="c1"># declarations for pressure-dependence variables</span>
    <span class="k">if</span> <span class="n">pdep_flag</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // pressure dependence variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> k0;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> kinf;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> Pr;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span>
                       <span class="p">)</span>
            <span class="k">if</span> <span class="n">troe_flag</span><span class="p">:</span>
                <span class="c1"># troe variables</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // troe variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> logFcent;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> A;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> B;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span>
                           <span class="p">)</span>
            <span class="k">if</span> <span class="n">sri_flag</span><span class="p">:</span>
                <span class="c1"># sri variables</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // sri variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> X;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span>
                           <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // pressure dependence variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  register double k0;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  register double kinf;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  register double Pr;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>
            <span class="k">if</span> <span class="n">troe_flag</span><span class="p">:</span>
                <span class="c1"># troe variables</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // troe variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;  register double logFcent;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;  register double A;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;  register double B;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="p">)</span>
            <span class="k">if</span> <span class="n">sri_flag</span><span class="p">:</span>
                <span class="c1"># sri variables</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // sri variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  register double X;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! pressure dependence variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;  double precision :: k0, kinf, Pr</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>
            <span class="k">if</span> <span class="n">troe_flag</span><span class="p">:</span>
                <span class="c1"># troe variables</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! troe variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;  double precision :: logFcent, A, B</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="p">)</span>
            <span class="k">if</span> <span class="n">sri_flag</span><span class="p">:</span>
                <span class="c1"># sri variables</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! sri variable declarations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double precision :: X</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> logT = log(T);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> m = pres / (</span><span class="si">{:.8e}</span><span class="s1"> * T);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span>
                                                    <span class="n">double_type</span><span class="p">,</span> <span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  register double logT = log(T);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  register double m = pres / (&#39;</span>
                   <span class="s1">&#39;</span><span class="si">{:.8e}</span><span class="s1"> * T);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  logT = log(T)</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  m = pres / (</span><span class="si">{:.8e}</span><span class="s1"> * T)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  logT = log(T);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  m = pres / (</span><span class="si">{:.8e}</span><span class="s1"> * T);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span>
                   <span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">pind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># loop through third-body and pressure-dependent reactions</span>
    <span class="k">for</span> <span class="n">rind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)):</span>
        <span class="n">reac</span> <span class="o">=</span> <span class="n">reacs</span><span class="p">[</span><span class="n">rind</span><span class="p">]</span>  <span class="c1"># index in reaction list</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">pdep</span> <span class="ow">or</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">printind</span> <span class="o">=</span> <span class="n">fwd_rxn_mapping</span><span class="p">[</span><span class="n">rind</span><span class="p">]</span>
        <span class="c1"># print reaction index</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  // reaction &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">printind</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  ! reaction &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">printind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  </span><span class="si">% r</span><span class="s1">eaction &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">printind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">the_vars</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">indexes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body_eff</span>
                                 <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">]</span>
                                 <span class="p">)</span>
                <span class="n">the_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">shared</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]</span>
                <span class="c1"># estimate usages as the number of consecutive reactions</span>
                <span class="n">usages</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">sp_i</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">i_rxn</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">):</span>
                        <span class="n">rxn</span> <span class="o">=</span> <span class="n">reacs</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">sp_i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body_eff</span>
                                       <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">]</span>
                                       <span class="p">):</span>
                            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">temp</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">usages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                <span class="n">smm</span><span class="o">.</span><span class="n">load_into_shared</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">the_vars</span><span class="p">,</span> <span class="n">usages</span><span class="p">)</span>

        <span class="c1"># third-body reaction</span>
        <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body</span><span class="p">:</span>

            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = m&#39;</span>

            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># pressure dependence</span>
        <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  thd = m&#39;</span>
                <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

            <span class="c1"># low-pressure limit rate</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  k0 = &#39;</span>
            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">reac</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">reac</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                       <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">reac</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">reac</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="c1"># high-pressure limit rate</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  kinf = &#39;</span>
            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">high</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">reac</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">reac</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                       <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">rxn_rate_const</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">reac</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">reac</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="c1"># reduced pressure</span>
            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  Pr = k0 * &#39;</span> <span class="o">+</span>
                        <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">reac</span><span class="o">.</span><span class="n">pdep_sp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; / kinf&#39;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  Pr = k0 * thd / kinf&#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">simple</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">troe</span><span class="p">:</span>
                <span class="c1"># Troe form</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  logFcent = log10( fmax(&#39;</span>
                        <span class="s1">&#39;</span><span class="si">{:.8e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(-T / </span><span class="si">{:.8e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(T / </span><span class="si">{:.8e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + </span><span class="si">{:.8e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(-T / </span><span class="si">{:.8e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(T / </span><span class="si">{:.8e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
                    <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(-</span><span class="si">{:.8e}</span><span class="s1"> / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(</span><span class="si">{:.8e}</span><span class="s1"> / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;, 1.0e-300))&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  A = log10(fmax(Pr, 1.0e-300)) - &#39;</span>
                        <span class="s1">&#39;0.67 * logFcent - 0.4&#39;</span> <span class="o">+</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  B = 0.806 - 1.1762 * logFcent - &#39;</span>
                        <span class="s1">&#39;0.14 * log10(fmax(Pr, 1.0e-300))&#39;</span> <span class="o">+</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">exp_10_fun</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;logFcent / (1.0 + A * A / (B * B))) &#39;</span>

            <span class="k">elif</span> <span class="n">reac</span><span class="o">.</span><span class="n">sri</span><span class="p">:</span>
                <span class="c1"># SRI form</span>

                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  X = 1.0 / (1.0 + log10(fmax(Pr, 1.0e-300)) * &#39;</span>
                        <span class="s1">&#39;log10(fmax(Pr, 1.0e-300)))&#39;</span> <span class="o">+</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = pow(</span><span class="si">{:.6}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># Need to check for negative parameters, and</span>
                <span class="c1"># skip &quot;-&quot; sign if so.</span>
                <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(-</span><span class="si">{:.6}</span><span class="s1"> / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;exp(</span><span class="si">{:.6}</span><span class="s1"> / T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + exp(-T / </span><span class="si">{:.6}</span><span class="s1">), X) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + exp(T / </span><span class="si">{:.6}</span><span class="s1">), X) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span>
                        <span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;* </span><span class="si">{:.8e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;pow(T, </span><span class="si">{:.6}</span><span class="s1">) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                             <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># simple falloff fn (i.e. F = 1)</span>
                <span class="n">simple</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span>
                <span class="c1"># regardless of F formulation</span>
                <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
                    <span class="c1"># unimolecular/recombination fall-off reaction</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; Pr / (1.0 + Pr)&#39;</span>
                <span class="k">elif</span> <span class="n">reac</span><span class="o">.</span><span class="n">high</span><span class="p">:</span>
                    <span class="c1"># chemically-activated bimolecular reaction</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;1.0 / (1.0 + Pr)&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">simple</span><span class="p">:</span>
                <span class="c1"># regardless of F formulation</span>
                <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
                    <span class="c1"># unimolecular/recombination fall-off reaction</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;* Pr / (1.0 + Pr)&#39;</span>
                <span class="k">elif</span> <span class="n">reac</span><span class="o">.</span><span class="n">high</span><span class="p">:</span>
                    <span class="c1"># chemically-activated bimolecular reaction</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;/ (1.0 + Pr)&#39;</span>

            <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># space in between each reaction</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">pind</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end get_rxn_pres_mod</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine get_rxn_pres_mod</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="write_spec_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.rate_subs.write_spec_rates">[docs]</a><span class="k">def</span> <span class="nf">write_spec_rates</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">fwd_spec_mapping</span><span class="p">,</span>
                    <span class="n">fwd_rxn_mapping</span><span class="p">,</span> <span class="n">smm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write subroutine to evaluate species rates of production.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Programming language.</span>
<span class="sd">    specs : list of `SpecInfo`</span>
<span class="sd">        List of species in mechanism.</span>
<span class="sd">    reacs : list of `ReacInfo`</span>
<span class="sd">        List of reactions in mechanism.</span>
<span class="sd">    fwd_spec_mapping : list of int</span>
<span class="sd">        the index of the species in the original mechanism</span>
<span class="sd">    fwd_rxn_mapping : list of int</span>
<span class="sd">        the index of the reactions in the original mechanism</span>
<span class="sd">    smm : shared_memory_manager, optional</span>
<span class="sd">        If not ```None```, `shared_memory_manager` to use for CUDA optimizations</span>
<span class="sd">    auto_diff : bool, optional</span>
<span class="sd">        If ```True```, generate files for Adept autodifferention library.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    seen : list of `bool`, ``True`` if species rate i is not identically zero</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;double&#39;</span>
    <span class="n">file_prefix</span> <span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;adouble&#39;</span>
        <span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;ad_&#39;</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">file_prefix</span> <span class="o">+</span> <span class="s1">&#39;spec_rates&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;header</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="p">)</span>
        <span class="c1">#if lang == &#39;cuda&#39; and smm is not None:</span>
        <span class="c1">#    file.write(&#39;#include &lt;assert.h&gt;\n&#39;)</span>
        <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;adept.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;using adept::adouble;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;</span><span class="si">{}</span><span class="s1">rates</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">num_s</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
    <span class="n">num_r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span>
    <span class="n">rev_reacs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">]</span>
    <span class="n">num_rev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_reacs</span><span class="p">)</span>

    <span class="c1"># pressure dependent reactions</span>
    <span class="n">pdep_reacs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_rxn</span><span class="p">,</span> <span class="n">reac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">thd_body</span> <span class="ow">or</span> <span class="n">reac</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
            <span class="c1"># add reaction index to list</span>
            <span class="n">pdep_reacs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_rxn</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span> <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;__device__ &#39;</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;void eval_spec_rates (const </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{1}</span><span class="s1"> fwd_rates,&#39;</span>
                 <span class="s1">&#39; const </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{1}</span><span class="s1"> rev_rates, const </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{1}</span><span class="s1"> pres_mod,&#39;</span>
                 <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{1}</span><span class="s1"> sp_rates, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{1}</span><span class="s1"> dy_N) {{</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                 <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;subroutine eval_spec_rates (fwd_rates, rev_rates,&#39;</span>
                 <span class="s1">&#39; pres_mod, sp_rates, dy_N)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                 <span class="p">)</span>

        <span class="c1"># fortran needs type declarations</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  double precision, intent(in) :: &#39;</span>
                 <span class="s1">&#39;fwd_rates(</span><span class="si">{0}</span><span class="s1">), rev_rates(</span><span class="si">{0}</span><span class="s1">), &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_r</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;pres_mod(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdep_reacs</span><span class="p">))</span>
                 <span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  double precision, intent(out) :: &#39;</span>
                 <span class="s1">&#39;sp_rates(</span><span class="si">{}</span><span class="s1">), dy_N</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;function sp_rates = eval_spec_rates (fwd_rates,&#39;</span>
                 <span class="s1">&#39; rev_rates, pres_mod, dy_N)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                 <span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  sp_rates = zeros(</span><span class="si">{}</span><span class="s1">,1);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__get_var</span><span class="p">(</span><span class="n">spind</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spind</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;(*dy_N)&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;sp_rates&#39;</span><span class="p">,</span> <span class="n">spind</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">__get_smm_var</span><span class="p">(</span><span class="n">sp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shared</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;sp_rates&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span> <span class="k">if</span> <span class="n">sp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> \
            <span class="k">else</span> <span class="n">shared</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;(*dy_N)&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1">#if lang == &#39;cuda&#39; and smm is not None:</span>
    <span class="c1">#    file.write(&#39;  assert(threadIdx.x + {} * blockDim.x &lt; {});\n&#39;.format(</span>
    <span class="c1">#        smm.shared_per_thread - 1, smm.shared_per_block))</span>
    <span class="n">first_use</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
    <span class="n">first_smem_use</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
    <span class="n">new_loads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">__on_eviction</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">shared_ind</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sp</span><span class="o">.</span><span class="n">index</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">= </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">to_string</span><span class="p">(),</span>
                    <span class="c1"># is only a += if the species in question has been updated</span>
                    <span class="c1"># previously</span>
                   <span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">first_use</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="n">shared</span><span class="p">)</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="n">first_use</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">get_array</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">get_array</span> <span class="o">=</span> <span class="n">smm</span><span class="o">.</span><span class="n">get_array</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">write_init</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">set_on_eviction</span><span class="p">(</span><span class="n">__on_eviction</span><span class="p">)</span>

    <span class="c1">#loop through reaction</span>
    <span class="k">for</span> <span class="n">rind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)):</span>
        <span class="n">print_ind</span> <span class="o">=</span> <span class="n">fwd_rxn_mapping</span><span class="p">[</span><span class="n">rind</span><span class="p">]</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
                    <span class="s1">&#39;rxn </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">print_ind</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">rxn</span> <span class="o">=</span> <span class="n">reacs</span><span class="p">[</span><span class="n">rind</span><span class="p">]</span>
        <span class="c1">#get allowed species</span>
        <span class="n">my_specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">the_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">__get_smm_var</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">my_specs</span><span class="p">]</span>
            <span class="c1"># estimate usages</span>
            <span class="n">usages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">rind</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="ow">and</span>
                      <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">reacs</span><span class="p">[</span><span class="n">temp</span><span class="p">]))</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">usages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span> <span class="o">-</span> <span class="n">rind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">first_smem_use</span> <span class="o">=</span> <span class="n">smm</span><span class="o">.</span><span class="n">load_into_shared</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">the_vars</span><span class="p">,</span>
                                                  <span class="n">usages</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span>
                                                  <span class="p">)</span>

        <span class="c1"># loop through species</span>
        <span class="k">for</span> <span class="n">spind</span> <span class="ow">in</span> <span class="n">my_specs</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">spind</span><span class="p">]</span>

            <span class="c1">#find nu</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="n">spind</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
                       <span class="s1">&#39;sp </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fwd_spec_mapping</span><span class="p">[</span><span class="n">spind</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span>

            <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">nu</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;+&#39;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">__get_var</span><span class="p">(</span><span class="n">spind</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tempvar</span> <span class="o">=</span> <span class="n">__get_smm_var</span><span class="p">(</span><span class="n">spind</span><span class="p">)</span>
                <span class="n">smem_ind</span><span class="p">,</span> <span class="n">smem_var</span> <span class="o">=</span> <span class="n">smm</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">tempvar</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">smem_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">#this is loaded into shared memory</span>
                    <span class="k">if</span> <span class="n">first_smem_use</span><span class="p">[</span><span class="n">smem_ind</span><span class="p">]:</span>
                        <span class="c1">#if it&#39;s the first time the value has been used</span>
                        <span class="c1">#use an =&#39;s</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sign</span> <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#otherwise +/- =</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">= &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
                    <span class="n">first_smem_use</span><span class="p">[</span><span class="n">smem_ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#this is not loaded into shared memory</span>
                    <span class="k">if</span> <span class="n">first_use</span><span class="p">[</span><span class="n">spind</span><span class="p">]:</span>
                        <span class="c1">#if it&#39;s the first time the value has been used</span>
                        <span class="c1">#use an =&#39;s</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sign</span> <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#otherwise +/- =</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">= &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
                    <span class="n">first_use</span><span class="p">[</span><span class="n">spind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">= &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sign</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">first_use</span><span class="p">[</span><span class="n">spind</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">seen</span><span class="p">[</span><span class="n">spind</span><span class="p">]</span> <span class="ow">and</span> <span class="n">nu</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="n">sign</span>
                <span class="n">first_use</span><span class="p">[</span><span class="n">spind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nu</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:3}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
                <span class="n">rxn_out</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;rev_rates&#39;</span><span class="p">,</span>
                                <span class="n">rev_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rxn_out</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;fwd_rates&#39;</span><span class="p">,</span> <span class="n">rind</span><span class="p">)</span>

            <span class="n">seen</span><span class="p">[</span><span class="n">spind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># pressure dependence modification</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span><span class="p">:</span>
                <span class="n">pind</span> <span class="o">=</span> <span class="n">pdep_reacs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span>
                <span class="n">rxn_out</span> <span class="o">+=</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pind</span><span class="p">)</span>

            <span class="c1"># if lang == &#39;cuda&#39;:</span>
            <span class="c1">#    rxn_out = get_array(lang, rxn_out, None, preformed=True)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">rxn_out</span>

            <span class="c1"># done with this species</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">seen_sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seen</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seen_sp</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span>
                <span class="s1">&#39;sp </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fwd_spec_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">__get_var</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; = 0.0&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                       <span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="ow">and</span> <span class="n">smm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">force_eviction</span><span class="p">()</span>
        <span class="n">smm</span><span class="o">.</span><span class="n">set_on_eviction</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_spec_rates</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_spec_rates</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">seen</span></div>


<div class="viewcode-block" id="write_chem_utils"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.rate_subs.write_chem_utils">[docs]</a><span class="k">def</span> <span class="nf">write_chem_utils</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">auto_diff</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write subroutine to evaluate species thermodynamic properties.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Thermodynamic properties include:  enthalpy, energy, specific heat</span>
<span class="sd">    (constant pressure and volume).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Programming language.</span>
<span class="sd">    specs : list of `SpecInfo`</span>
<span class="sd">        List of species in the mechanism.</span>
<span class="sd">    auto_diff : bool, optional</span>
<span class="sd">        If ``True``, generate files for Adept autodifferention library.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;double&#39;</span>
    <span class="n">pres_ref</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;ad_&#39;</span>
        <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;adouble&#39;</span>
        <span class="n">pres_ref</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>

    <span class="n">num_s</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

    <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;__device__ &#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_prefix</span> <span class="o">+</span> <span class="s1">&#39;chem_utils&#39;</span>
                             <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef CHEM_UTILS_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#define CHEM_UTILS_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#include &quot;header</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;adept.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;using adept::adouble;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;gpu_memory.cuh&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
               <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_conc (const </span><span class="si">{1}{2}</span><span class="s1">, const </span><span class="si">{1}{2}</span><span class="s1">, &#39;</span>
               <span class="s1">&#39;const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_conc_rho (const </span><span class="si">{1}{2}</span><span class="s1">, const </span><span class="si">{1}{2}</span><span class="s1">, &#39;</span>
               <span class="s1">&#39;const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_h (const </span><span class="si">{1}{2}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_u (const </span><span class="si">{1}{2}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_cv (const </span><span class="si">{1}{2}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void eval_cp (const </span><span class="si">{1}{2}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span>
                                 <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
               <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">file_prefix</span> <span class="o">+</span> <span class="s1">&#39;chem_utils&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;header</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;</span><span class="si">{}</span><span class="s1">chem_utils</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;adept.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;using adept::adouble;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="c1">###################################</span>
    <span class="c1"># species concentrations subroutine</span>
    <span class="c1">###################################</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">pre</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;void eval_conc (const </span><span class="si">{0}{1}</span><span class="s1"> T, const </span><span class="si">{0}{1}</span><span class="s1"> pres, &#39;</span>
                 <span class="s1">&#39;const </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> y, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> y_N, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> mw_avg, &#39;</span>
                 <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> rho, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> conc) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                 <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                 <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="c1"># fortran needs type declarations</span>
            <span class="s1">&#39;subroutine eval_conc (T, pres, y, y_N, &#39;</span>
            <span class="s1">&#39;mw_avg, rho, conc)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;  double precision, intent(in) :: T, pres, &#39;</span>
            <span class="s1">&#39;mass_frac</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39;  double precision, intent(out) :: y_N, mw_avg, &#39;</span>
            <span class="s1">&#39;rho, conc(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;function conc = eval_conc (T, pres, y, y_N, &#39;</span>
                 <span class="s1">&#39;mw_avg, rho, conc)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                 <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Get mass fraction of last species</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // mass fraction of final species</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  *y_N = 1.0 - (&#39;</span>
    <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;               &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># calculation of mw avg</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  *mw_avg = &#39;</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;     &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + ((*y_N) * </span><span class="si">{:.16e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  *mw_avg = 1.0 / *mw_avg;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># calculation of density</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // mass-averaged density</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  *rho = pres * (*mw_avg) / (</span><span class="si">{:.8e}</span><span class="s1"> * T)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># calculation of species molar concentrations</span>

    <span class="c1"># loop through species</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(*rho) * &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = (*rho) * (*y_N) * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_conc</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_conc</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">#######################################################################</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">pre</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;void eval_conc_rho (const </span><span class="si">{0}{1}</span><span class="s1"> T, const </span><span class="si">{0}{1}</span><span class="s1"> rho, &#39;</span>
                 <span class="s1">&#39;const </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> y, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> y_N, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> mw_avg, &#39;</span>
                 <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> pres, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> conc) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                 <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                 <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="c1"># fortran needs type declarations</span>
            <span class="s1">&#39;subroutine eval_conc_rho (temp, rho, mass_frac, y_N, &#39;</span>
            <span class="s1">&#39;mw_avg, pres, conc)</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;  double precision, intent(in) :: &#39;</span>
            <span class="s1">&#39;T, rho, mass_frac(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39;  double precision, intent(out) :: &#39;</span>
            <span class="s1">&#39;conc(</span><span class="si">{}</span><span class="s1">), y_N, mw_avg, pres</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;function conc = eval_conc_rho (temp, rho, mass_frac, y_N, &#39;</span>
                 <span class="s1">&#39;mw_avg, pres, conc)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                 <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Get mass fraction of last species</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // mass fraction of final species</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  *y_N = 1.0 - (&#39;</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;               &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># calculation of mw avg</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  *mw_avg = &#39;</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;     &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + ((*y_N) * </span><span class="si">{:.16e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  *mw_avg = 1.0 / *mw_avg;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># calculation of pressure</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // pressure</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  *pres = rho * </span><span class="si">{:.8e}</span><span class="s1"> * T / (*mw_avg)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># calculation of species molar concentrations</span>

    <span class="c1"># loop through species</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;rho * &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; = rho * (*y_N) * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_conc</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_conc</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">######################</span>
    <span class="c1"># enthalpy subroutine</span>
    <span class="c1">######################</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">pre</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;void eval_h (const </span><span class="si">{0}{1}</span><span class="s1"> T, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> h) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;subroutine eval_h (T, h)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                 <span class="c1"># fortran needs type declarations</span>
                 <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  double precision, intent(in) :: T</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  double precision, intent(out) :: h(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;function h = eval_h (T)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># loop through species</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  if (T &lt;= </span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; then</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = </span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T)))))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  } else {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  else</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = </span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T)))))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end if</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_h</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_h</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">#################################</span>
    <span class="c1"># internal energy subroutine</span>
    <span class="c1">#################################</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">pre</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;void eval_u (const </span><span class="si">{0}{1}</span><span class="s1"> T, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> u) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;subroutine eval_u (T, u)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                 <span class="c1"># fortran needs type declarations</span>
                 <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  double precision, intent(in) :: T</span><span class="se">\n</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;  double precision, intent(out) :: u(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;function u = eval_u (T)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># loop through species</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  if (T &lt;= </span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; then</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = </span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> - 1.0 + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T)))))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  } else {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  else</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = </span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> - 1.0 + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T)))))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end if</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_u</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_u</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">##################################</span>
    <span class="c1"># cv subroutine</span>
    <span class="c1">##################################</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;void eval_cv (const </span><span class="si">{0}{1}</span><span class="s1"> T, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> cv) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;subroutine eval_cv (T, cv)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="c1"># fortran needs type declarations</span>
                <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;  double precision, intent(in) :: T</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;  double precision, intent(out) :: cv(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;function cv = eval_cv (T)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># loop through species</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  if (T &lt;= </span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; then</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = </span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> - 1.0 + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T))))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  } else {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  else</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = </span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> - 1.0 + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T))))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end if</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_cv</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_cv</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">###############################</span>
    <span class="c1"># cp subroutine</span>
    <span class="c1">###############################</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;void eval_cp (const </span><span class="si">{0}{1}</span><span class="s1"> T, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> cp) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;subroutine eval_cp (T, cp)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="c1"># fortran needs type declarations</span>
                <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;  double precision, intent(in) :: T</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;  double precision, intent(out) :: cp(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_s</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;function cp = eval_cp (T)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># loop through species</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  if (T &lt;= </span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; {</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; then</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = </span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T))))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  } else {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  else</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; = </span><span class="si">{:.16e}</span><span class="s1"> * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;(</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + T * (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> + &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> * T))))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                 <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  }</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end if</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end eval_cp</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end subroutine eval_cp</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="write_derivs"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.rate_subs.write_derivs">[docs]</a><span class="k">def</span> <span class="nf">write_derivs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reacs</span><span class="p">,</span> <span class="n">specs_nonzero</span><span class="p">,</span> <span class="n">auto_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes derivative function file and header.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Programming language.</span>
<span class="sd">    specs : list of `SpecInfo`</span>
<span class="sd">        List of species in the mechanism.</span>
<span class="sd">    reacs : list of `ReacInfo`</span>
<span class="sd">        List of reactions in the mechanism.</span>
<span class="sd">    specs_nonzero : list of bool</span>
<span class="sd">        List of `bool` indicating species with zero net production</span>
<span class="sd">    auto_diff : bool, optional</span>
<span class="sd">        If ``True``, generate files for Adept autodifferention library.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;double&#39;</span>
    <span class="n">pres_ref</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;ad_&#39;</span>
        <span class="n">double_type</span> <span class="o">=</span> <span class="s1">&#39;adouble&#39;</span>
        <span class="n">pres_ref</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>

    <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span> <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;__device__ &#39;</span>

    <span class="c1"># first write header file</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_prefix</span> <span class="o">+</span> <span class="s1">&#39;dydt&#39;</span> <span class="o">+</span>
                            <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifndef DYDT_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#define DYDT_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#include &quot;header</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;adept.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;using adept::adouble;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">void dydt (const double, const </span><span class="si">{1}{2}</span><span class="s1">, &#39;</span>
               <span class="s1">&#39;const </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> * </span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span>
                                <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
               <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="k">else</span>
                    <span class="s1">&#39;, const mechanism_memory * </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span> <span class="o">+</span>
               <span class="s1">&#39;);</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">file_prefix</span> <span class="o">+</span> <span class="s1">&#39;dydt&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;header</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;</span><span class="si">{0}</span><span class="s1">chem_utils</span><span class="si">{1}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;#include &quot;</span><span class="si">{0}</span><span class="s1">rates</span><span class="si">{1}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">,</span>
                                            <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;gpu_memory.cuh&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auto_diff</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;adept.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;using adept::adouble;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">##################################################################</span>
    <span class="c1"># constant pressure</span>
    <span class="c1">##################################################################</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#if defined(CONP)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;void dydt (const double t, const </span><span class="si">{0}{1}</span><span class="s1"> pres, &#39;</span>
                  <span class="s1">&#39;const </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> y, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{2}</span><span class="s1"> dy</span><span class="si">{3}</span><span class="s1">) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                  <span class="n">double_type</span><span class="p">,</span> <span class="n">pres_ref</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span>
                  <span class="s1">&#39;, const mechanism_memory * </span><span class="si">{}</span><span class="s1"> d_mem&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                  <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># calculation of species molar concentrations</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // species molar concentrations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> conc[</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
               <span class="k">else</span> <span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> conc = d_mem-&gt;conc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
               <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
               <span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> y_N;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> mw_avg;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> rho;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>

    <span class="c1"># Simply call subroutine</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_conc (&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
               <span class="s1">&#39;, pres, &amp;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
                                <span class="k">else</span> <span class="s1">&#39;y[GRID_DIM]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
               <span class="s1">&#39;&amp;y_N, &amp;mw_avg, &amp;rho, conc);</span><span class="se">\n\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>

    <span class="c1"># evaluate reaction rates</span>
    <span class="n">rev_reacs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> fwd_rates = d_mem-&gt;fwd_rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // local arrays holding reaction rates</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> fwd_rates[</span><span class="si">{}</span><span class="s1">];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">))</span>
                   <span class="p">)</span>
    <span class="k">if</span> <span class="n">rev_reacs</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> rev_rates = d_mem-&gt;rev_rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">rev_reacs</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> rev_rates[</span><span class="si">{}</span><span class="s1">];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_reacs</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1">* rev_rates = 0;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">cheb</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">cheb</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">cheb</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> dot_prod = d_mem-&gt;dot_prod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_rxn_rates (&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
               <span class="s1">&#39;, pres, conc, fwd_rates, rev_rates</span><span class="si">{}</span><span class="s1">);</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, dot_prod&#39;</span>
                    <span class="k">if</span> <span class="n">cheb</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
               <span class="p">)</span>

    <span class="c1"># reaction pressure dependence</span>
    <span class="n">num_dep_reacs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">num_dep_reacs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // get pressure modifications to reaction rates</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> pres_mod = d_mem-&gt;pres_mod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> pres_mod[</span><span class="si">{}</span><span class="s1">];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="n">num_dep_reacs</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  get_rxn_pres_mod (&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;, pres, conc, pres_mod);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1">* pres_mod = 0;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> spec_rates = d_mem-&gt;spec_rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># species rate of change of molar concentration</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // evaluate species molar net production rates</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> dy_N;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_spec_rates (fwd_rates, rev_rates, pres_mod, &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &amp;dy_N)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;spec_rates, &amp;&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># evaluate specific heat</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // local array holding constant pressure specific heat</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> cp[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
               <span class="k">else</span> <span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> cp = d_mem-&gt;cp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
               <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_cp (&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, cp)&#39;</span>
               <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // constant pressure mass-average specific heat</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> cp_avg = &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;             &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * y_N)&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // local array for species enthalpies</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
              <span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> h[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
               <span class="k">else</span> <span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> h = d_mem-&gt;h&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
               <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_h(&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, h);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># energy equation</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // rate of change of temperature</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39; = (-1.0 / (rho * cp_avg)) * (&#39;</span>
            <span class="p">)</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">specs_nonzero</span><span class="p">[</span><span class="n">isp</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;       &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">isp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;dy_N&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">arr</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                 <span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># rate of change of species mass fractions</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // calculate rate of change of species mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39; *= (</span><span class="si">{:.16e}</span><span class="s1"> / rho);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                   <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; * (</span><span class="si">{:.16e}</span><span class="s1"> / rho);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end dydt</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">##################################################################</span>
    <span class="c1"># constant volume</span>
    <span class="c1">##################################################################</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#elif defined(CONV)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;void dydt (const double t, const </span><span class="si">{0}</span><span class="s1"> rho, &#39;</span>
                     <span class="s1">&#39;const </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{1}</span><span class="s1"> y, </span><span class="si">{0}</span><span class="s1"> * </span><span class="si">{1}</span><span class="s1"> dy</span><span class="si">{2}</span><span class="s1">) {{</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span>
                     <span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span>
                     <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span>
                     <span class="s1">&#39;, mechanism_memory * </span><span class="si">{}</span><span class="s1"> d_mem&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
               <span class="p">)</span>

    <span class="c1"># calculation of species molar concentrations</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // species molar concentrations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1"> conc[</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
               <span class="k">else</span> <span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> conc = d_mem-&gt;conc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
               <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
               <span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> y_N;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> mw_avg;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> pres;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>

    <span class="c1"># Simply call subroutine</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_conc_rho (&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
               <span class="s1">&#39;rho, &amp;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
                                <span class="k">else</span> <span class="s1">&#39;y[GRID_DIM]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span>
               <span class="s1">&#39;&amp;y_N, &amp;mw_avg, &amp;pres, conc);</span><span class="se">\n\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>

    <span class="c1"># evaluate reaction rates</span>
    <span class="n">rev_reacs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rev</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> fwd_rates = d_mem-&gt;fwd_rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // local arrays holding reaction rates</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> fwd_rates[</span><span class="si">{}</span><span class="s1">];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">))</span>
                   <span class="p">)</span>
    <span class="k">if</span> <span class="n">rev_reacs</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> rev_rates = d_mem-&gt;rev_rates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
                   <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">rev_reacs</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> rev_rates[</span><span class="si">{}</span><span class="s1">];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_reacs</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1">* rev_rates = 0;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_rxn_rates (&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
               <span class="s1">&#39;pres, conc, fwd_rates, rev_rates);</span><span class="se">\n\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>

    <span class="c1"># reaction pressure dependence</span>
    <span class="n">num_dep_reacs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">rxn</span><span class="o">.</span><span class="n">thd_body</span> <span class="ow">or</span> <span class="n">rxn</span><span class="o">.</span><span class="n">pdep</span> <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reacs</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">num_dep_reacs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // get pressure modifications to reaction rates</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> pres_mod = d_mem-&gt;pres_mod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span> <span class="o">+</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> pres_mod[</span><span class="si">{}</span><span class="s1">];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="n">num_dep_reacs</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  get_rxn_pres_mod (&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;, pres, conc, pres_mod);</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1">* pres_mod = 0;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">))</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># species rate of change of molar concentration</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // evaluate species molar net production rates</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> dy_N;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span> <span class="o">+</span>
               <span class="s1">&#39;  eval_spec_rates (fwd_rates, rev_rates, pres_mod, &#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
           <span class="k">else</span> <span class="s1">&#39;&amp;dy[GRID_DIM]&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;, &amp;dy_N)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># evaluate specific heat</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> cv[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
               <span class="k">else</span> <span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> cv = d_mem-&gt;cp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
               <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_cv(&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, cv);</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // constant volume mass-average specific heat</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> cv_avg = &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">)</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;             &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                 <span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * y_N)&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># evaluate internal energy</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // local array for species internal energies</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
              <span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> u[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">double_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span> <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;cuda&#39;</span>
               <span class="k">else</span> <span class="s1">&#39;  double * </span><span class="si">{}</span><span class="s1"> u = d_mem-&gt;h&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">restrict</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>
               <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  eval_u (&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, u);</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># energy equation</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // rate of change of temperature</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39; = (-1.0 / (rho * cv_avg)) * (&#39;</span>
            <span class="p">)</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">specs_nonzero</span><span class="p">[</span><span class="n">isp</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;       &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">isp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;dy_N&#39;</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">arr</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span>
                 <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                 <span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


    <span class="c1"># rate of change of species mass fractions</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // calculate rate of change of species mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39; *= (</span><span class="si">{:.16e}</span><span class="s1"> / rho);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                   <span class="p">)</span>
        <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; * (</span><span class="si">{:.16e}</span><span class="s1"> / rho);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end dydt</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="write_mass_mole"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.rate_subs.write_mass_mole">[docs]</a><span class="k">def</span> <span class="nf">write_mass_mole</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write files for mass/molar concentration and density conversion utility.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to build directory for file.</span>
<span class="sd">    lang : {&#39;c&#39;, &#39;cuda&#39;, &#39;fortran&#39;, &#39;matlab&#39;}</span>
<span class="sd">        Programming language.</span>
<span class="sd">    specs : list of `SpecInfo`</span>
<span class="sd">        List of species in mechanism.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create header file</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">arr_lang</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;mass_mole</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;#ifndef MASS_MOLE_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;#define MASS_MOLE_HEAD</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;#include &quot;header</span><span class="si">{0}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;void mole2mass (const double*, double*);</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;void mass2mole (const double*, double*);</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;double getDensity (const double, const double, const double*);</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Open file; both C and CUDA programs use C file (only used on host)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;mass_mole&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;mass_mole</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">header_ext</span><span class="p">[</span><span class="n">lang</span><span class="p">]))</span>

    <span class="c1">###################################################</span>
    <span class="c1"># Documentation and function/subroutine initializaton for mole2mass</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/** Function converting species mole fractions to &#39;</span>
                   <span class="s1">&#39;mass fractions.</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; *</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; * \param[in]  X  array of species mole fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; * \param[out] Y  array of species mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; */</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;void mole2mass (const double * X, double * Y) {</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s1">&#39;!-----------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;!&gt; Subroutine converting species mole fractions to mass fractions.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;!! @param[in]  X  array of species mole fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;!! @param[out] Y  array of species mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;!-----------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;subroutine mole2mass (X, Y)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  double, dimension(:), intent(in) :: X</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  double, dimension(:), intent(out) :: X</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  double :: mw_avg</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // mole fraction of final species</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double X_N&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  X_N = 1.0 - (&#39;</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;               &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># calculate molecular weight</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // average molecular weight</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double mw_avg = 0.0;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg += &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;mw_avg += X_N * &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! average molecular weight</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  mw_avg = 0.0</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg = mw_avg + &#39;</span>
                       <span class="s1">&#39;X(</span><span class="si">{}</span><span class="s1">) * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># calculate mass fractions</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // calculate mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39; = &#39;</span> <span class="o">+</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1"> / mw_avg;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;} // end mole2mass</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! calculate mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  Y(</span><span class="si">{0}</span><span class="s1">) = X(</span><span class="si">{0}</span><span class="s1">) * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1"> / mw_avg</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;end subroutine mole2mass</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>

    <span class="c1">################################</span>
    <span class="c1"># Documentation and function/subroutine initialization for mass2mole</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/** Function converting species mass fractions to mole &#39;</span>
                   <span class="s1">&#39;fractions.</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; *</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; * \param[in]  Y  array of species mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; * \param[out] X  array of species mole fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; */</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;void mass2mole (const double * Y, double * X) {</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;!-------------------------------------------------------&#39;</span>
                   <span class="s1">&#39;----------</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!&gt; Subroutine converting species mass fractions to mole &#39;</span>
                   <span class="s1">&#39;fractions.</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!! @param[in]  Y  array of species mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!! @param[out] X  array of species mole fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!-------------------------------------------------------&#39;</span>
                   <span class="s1">&#39;----------</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;subroutine mass2mole (Y, X)</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double, dimension(:), intent(in) :: Y</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double, dimension(:), intent(out) :: X</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double :: mw_avg</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>

    <span class="c1"># calculate Y_N</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // mass fraction of final species</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double Y_N&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  Y_N = 1.0 - (&#39;</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;               &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># calculate average molecular weight</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // average molecular weight</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  double mw_avg = 0.0;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg += &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; / </span><span class="si">{:.16e}</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg += Y_N / &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg = 1.0 / mw_avg;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! average molecular weight</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg = 0.0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg = mw_avg + &#39;</span>
                       <span class="s1">&#39;Y(</span><span class="si">{}</span><span class="s1">) / &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># calculate mole fractions</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // calculate mole fractions</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
                      <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>
                      <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; * mw_avg / </span><span class="si">{:.16e}</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;} // end mass2mole</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! calculate mass fractions</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  X(</span><span class="si">{0}</span><span class="s1">) = Y(</span><span class="si">{0}</span><span class="s1">) * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;mw_avg / </span><span class="si">{:.16e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;end subroutine mass2mole</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>

    <span class="c1">###############################</span>
    <span class="c1"># Documentation and subroutine/function initialization for getDensity</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/** Function calculating density from mole fractions.</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; *</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; * \param[in]  temp  temperature</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; * \param[in]  pres  pressure</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; * \param[in]  X     array of species mole fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">r&#39; * \return     rho  mixture mass density&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39; */</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;double getDensity (const double temp, const double &#39;</span>
                   <span class="s1">&#39;pres, &#39;</span>
                   <span class="s1">&#39;const double * X) {</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;!-------------------------------------------------------&#39;</span>
                   <span class="s1">&#39;----------</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!&gt; Function calculating density from mole fractions.</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!! @param[in]  temp  temperature</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!! @param[in]  pres  pressure</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!! @param[in]  X     array of species mole fractions</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!! @return     rho   mixture mass density&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;!-------------------------------------------------------&#39;</span>
                   <span class="s1">&#39;----------</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;function mass2mole (temp, pres, X) result(rho)</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  implicit none</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double, intent(in) :: temp, pres</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double, dimension(:), intent(in) :: X</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double :: mw_avg, rho</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // mole fraction of final species</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;double X_N&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  X_N = 1.0 - (&#39;</span>
    <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;               &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfirst</span><span class="p">:</span> <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>

        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>

        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>

    <span class="c1"># get molecular weight</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  // average molecular weight</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  double mw_avg = 0.0;</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg += &#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">arr_lang</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; * </span><span class="si">{:.16e}</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">line_start</span> <span class="o">+</span> <span class="s1">&#39;mw_avg += X_N * &#39;</span> <span class="o">+</span>
               <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mw</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  ! average molecular weight</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;  mw_avg = 0.0</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="p">)</span>
        <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  mw_avg = mw_avg + &#39;</span>
                       <span class="s1">&#39;X(</span><span class="si">{}</span><span class="s1">) * &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;</span><span class="si">{:.16e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># calculate density</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  return pres * mw_avg / (</span><span class="si">{:.8e}</span><span class="s1"> * temp);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  rho = pres * mw_avg / (</span><span class="si">{:.8e}</span><span class="s1"> * temp)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">line_end</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">]:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;} // end getDensity</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end function getDensity</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">create_jacobian</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parser</span><span class="p">()</span>
    <span class="n">create_jacobian</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span>
                <span class="n">mech_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                <span class="n">therm_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">thermo</span><span class="p">,</span>
                <span class="n">optimize_cache</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_optimizer</span><span class="p">,</span>
                <span class="n">initial_state</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">initial_conditions</span><span class="p">,</span>
                <span class="n">num_blocks</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_threads</span><span class="p">,</span>
                <span class="n">no_shared</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">no_shared</span><span class="p">,</span>
                <span class="n">L1_preferred</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">L1_preferred</span><span class="p">,</span>
                <span class="n">multi_thread</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">multi_thread</span><span class="p">,</span>
                <span class="n">force_optimize</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force_optimize</span><span class="p">,</span>
                <span class="n">build_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span>
                <span class="n">skip_jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">last_spec</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">last_species</span><span class="p">,</span>
                <span class="n">auto_diff</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">auto_diff</span>
                <span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">pyJac</a></h1>



<p class="blurb">Python-based generator of analytical Jacobians for chemical kinetics</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=kyleniemeyer&repo=pyjac&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/index.html">pyJac API</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Kyle Niemeyer, Nicholas Curtis.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.9</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    
    <a href="https://github.com/kyleniemeyer/pyjac" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>